

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29645087-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ssh &mdash; Gate One 1.2.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.png"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
  

  
    <link rel="top" title="Gate One 1.2.0 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Gate One
          

          
          </a>

          
            
            
              <div class="version">
                1.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../About/index.html">About Gate One</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Applications/index.html">Gate One Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developer/index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ReleaseNotes/index.html">Release Notes / Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Gate One</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>ssh</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ssh</h1><div class="highlight"><pre>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1">#       Copyright 2011 Liftoff Software Corporation</span>
<span class="c1">#</span>

<span class="c1"># TODO: Complete this docstring...</span>
<span class="n">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">ssh.py - A plugin for Gate One that adds additional SSH-specific features.</span>

<span class="s2">Hooks</span>
<span class="s2">-----</span>
<span class="s2">This Python plugin file implements the following hooks::</span>

<span class="s2">    hooks = {</span>
<span class="s2">        &#39;WebSocket&#39;: {</span>
<span class="s2">            &#39;terminal:ssh_get_known_hosts&#39;: get_known_hosts,</span>
<span class="s2">            &#39;terminal:ssh_save_known_hosts&#39;: save_known_hosts,</span>
<span class="s2">            &#39;terminal:ssh_get_connect_string&#39;: get_connect_string,</span>
<span class="s2">            &#39;terminal:ssh_execute_command&#39;: ws_exec_command,</span>
<span class="s2">            &#39;terminal:ssh_get_identities&#39;: get_identities,</span>
<span class="s2">            &#39;terminal:ssh_get_public_key&#39;: get_public_key,</span>
<span class="s2">            &#39;terminal:ssh_get_private_key&#39;: get_private_key,</span>
<span class="s2">            &#39;terminal:ssh_get_host_fingerprint&#39;: get_host_fingerprint,</span>
<span class="s2">            &#39;terminal:ssh_gen_new_keypair&#39;: generate_new_keypair,</span>
<span class="s2">            &#39;terminal:ssh_store_id_file&#39;: store_id_file,</span>
<span class="s2">            &#39;terminal:ssh_delete_identity&#39;: delete_identity,</span>
<span class="s2">            &#39;terminal:ssh_set_default_identities&#39;: set_default_identities</span>
<span class="s2">        },</span>
<span class="s2">        &#39;Escape&#39;: opt_esc_handler,</span>
<span class="s2">        &#39;Events&#39;: {</span>
<span class="s2">            &#39;terminal:authenticate&#39;: send_css_template,</span>
<span class="s2">            &#39;terminal:authenticate&#39;: create_user_ssh_dir</span>
<span class="s2">        }</span>
<span class="s2">    }</span>

<span class="s2">Docstrings</span>
<span class="s2">----------</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.1&#39;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;GNU AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="c1"># Python stdlib</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># Our stuff</span>
<span class="kn">from</span> <span class="nn">gateone.core.server</span> <span class="kn">import</span> <span class="n">BaseHandler</span>
<span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">shell_command</span><span class="p">,</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">gateone.core.utils</span> <span class="kn">import</span> <span class="n">noop</span><span class="p">,</span> <span class="n">bind</span>
<span class="kn">from</span> <span class="nn">gateone.core.locale</span> <span class="kn">import</span> <span class="n">get_translation</span>
<span class="kn">from</span> <span class="nn">gateone.core.log</span> <span class="kn">import</span> <span class="n">go_logger</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">get_translation</span><span class="p">()</span>

<span class="c1"># Tornado stuff</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>

<span class="c1"># Globals</span>
<span class="n">ssh_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s2">&quot;gateone.terminal.ssh&quot;</span><span class="p">,</span> <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
<span class="n">OPENSSH_VERSION</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">DROPBEAR_VERSION</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">PLUGIN_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Path to this plugin&#39;s directory</span>
<span class="n">OPEN_SUBCHANNELS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">SUBCHANNEL_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># How long to wait before auto-closing</span>
<span class="n">READY_STRING</span> <span class="o">=</span> <span class="s2">&quot;GATEONE_SSH_EXEC_CMD_CHANNEL_READY&quot;</span>
<span class="n">READY_MATCH</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^</span><span class="si">%s</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="n">READY_STRING</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="n">OUTPUT_MATCH</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s2">&quot;^{rs}.+^{rs}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rs</span><span class="o">=</span><span class="n">READY_STRING</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">VALID_PRIVATE_KEY</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s1">r&#39;^-----BEGIN [A-Z]+ PRIVATE KEY-----.*-----END [A-Z]+ PRIVATE KEY-----$&#39;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">TIMER</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># Used to store temporary, cancellable timeouts</span>
<span class="c1"># TODO: make execute_command() a user-configurable option...  So it will automatically run whatever command(s) the user likes whenever they connect to a given server.  Differentiate between when they connect and when they start up a master or slave channel.</span>

<span class="c1"># Exceptions</span>
<div class="viewcode-block" id="SSHMultiplexingException"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.SSHMultiplexingException">[docs]</a><span class="k">class</span> <span class="nc">SSHMultiplexingException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s a failure trying to open a sub-shell via OpenSSH&#39;s</span>
<span class="sd">    `Master mode &lt;http://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing&gt;`_</span>
<span class="sd">    multiplexing capability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="SSHExecutionException"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.SSHExecutionException">[docs]</a><span class="k">class</span> <span class="nc">SSHExecutionException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s an error trying to execute a command in the slave.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="SSHKeygenException"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.SSHKeygenException">[docs]</a><span class="k">class</span> <span class="nc">SSHKeygenException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s an error trying to generate a public/private keypair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="SSHKeypairException"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.SSHKeypairException">[docs]</a><span class="k">class</span> <span class="nc">SSHKeypairException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s an error trying to save public/private keypair or</span>
<span class="sd">    certificate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="SSHPassphraseException"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.SSHPassphraseException">[docs]</a><span class="k">class</span> <span class="nc">SSHPassphraseException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when we try to generate/decode something that requires a passphrase</span>
<span class="sd">    but no passphrase was given.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="get_ssh_dir"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_ssh_dir">[docs]</a><span class="k">def</span> <span class="nf">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a :class:`gateone.TerminalWebSocket` (*self*) instance, return the</span>
<span class="sd">    current user&#39;s ssh directory</span>

<span class="sd">    .. note:: If the user&#39;s ssh directory doesn&#39;t start with a . (dot) it will be renamed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
    <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c1"># &quot;User&#39;s dir&quot;</span>
    <span class="n">old_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s1">&#39;.ssh&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_ssh_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Renaming </span><span class="si">%s</span><span class="s2">&#39;s &#39;ssh&#39; directory to &#39;.ssh&#39;.&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_ssh_dir</span><span class="p">,</span> <span class="n">users_ssh_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Both an &#39;ssh&#39; and &#39;.ssh&#39; directory exist for user </span><span class="si">%s</span><span class="s2">.  &quot;</span>
                <span class="s2">&quot;Using the .ssh directory.&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">users_ssh_dir</span></div>

<div class="viewcode-block" id="open_sub_channel"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.open_sub_channel">[docs]</a><span class="k">def</span> <span class="nf">open_sub_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Opens a sub-channel of communication by executing a new shell on the SSH</span>
<span class="sd">    server using OpenSSH&#39;s `Master mode &lt;http://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing&gt;`_</span>
<span class="sd">    capability (it spawns a new slave) and returns the resulting</span>
<span class="sd">    :class:`termio.Multiplex` instance.  If a slave has already been opened for</span>
<span class="sd">    this purpose it will re-use the existing channel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">OPEN_SUBCHANNELS</span>
    <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">OPEN_SUBCHANNELS</span> <span class="ow">and</span> <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
        <span class="c1"># Use existing sub-channel (much faster this way)</span>
        <span class="k">return</span> <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Opening SSH sub-channel&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">})</span>
    <span class="c1"># NOTE: When connecting a slave via ssh you can&#39;t tell it to execute a</span>
    <span class="c1"># command like you normally can (e.g. &#39;ssh user@host &lt;some command&gt;&#39;).  This</span>
    <span class="c1"># is why we&#39;re using the termio.Multiplex.expect() functionality below...</span>
    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span>
    <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;session_dir&#39;</span><span class="p">]</span>
    <span class="n">session_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SSHMultiplexingException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;SSH Plugin: Unable to open slave sub-channel.&quot;</span><span class="p">))</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;ssh_socket&#39;</span><span class="p">]</span>
    <span class="c1"># Interesting: When using an existing socket you don&#39;t need to give it all</span>
    <span class="c1"># the same options as you used to open it but you still need to give it</span>
    <span class="c1"># *something* in place of the hostname or it will report a syntax error and</span>
    <span class="c1"># print out the help.  So that&#39;s why I&#39;ve put &#39;go_ssh_remote_cmd&#39; below.</span>
    <span class="c1"># ...but I could have just used &#39;foo&#39; :)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">socket_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SSHMultiplexingException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;SSH Plugin: Unable to open slave sub-channel.&quot;</span><span class="p">))</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">ssh_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ssh_config_path</span><span class="p">):</span>
        <span class="c1"># Create it (an empty one so ssh doesn&#39;t error out)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ssh_config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Hopefully &#39;go_ssh_remote_cmd&#39; will be a clear enough indication of</span>
    <span class="c1"># what is going on by anyone that has to review the logs...</span>
    <span class="n">ssh</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="n">ssh_command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -x -S&#39;</span><span class="si">%s</span><span class="s2">&#39; -F&#39;</span><span class="si">%s</span><span class="s2">&#39; go_ssh_remote_cmd&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">ssh</span><span class="p">,</span> <span class="n">socket_path</span><span class="p">,</span> <span class="n">ssh_config_path</span><span class="p">)</span>
    <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span>
        <span class="n">ssh_command</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (sub)&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
    <span class="c1"># Using huge numbers here so we don&#39;t miss much (if anything) if the user</span>
    <span class="c1"># executes something like &quot;ps -ef&quot;.</span>
    <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c1"># Hopefully 100/200 lines/cols is enough</span>
    <span class="c1"># ...if it isn&#39;t, well, that&#39;s not really what this is for :)</span>
    <span class="c1"># Set the term title so it gets a proper name in the logs</span>
    <span class="n">m</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s1">u&#39;echo -e &quot;</span><span class="se">\\</span><span class="s1">033]0;Term </span><span class="si">%s</span><span class="s1"> sub-channel</span><span class="se">\\</span><span class="s1">007&quot;&#39;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="wait_for_prompt"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.wait_for_prompt">[docs]</a><span class="k">def</span> <span class="nf">wait_for_prompt</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">matched</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`termio.Multiplex.expect` inside of :func:`execute_command`,</span>
<span class="sd">    clears the screen and executes *cmd*.  Also, sets an</span>
<span class="sd">    :func:`~termio.Multiplex.expect` to call :func:`get_cmd_output` when the</span>
<span class="sd">    end of the command output is detected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;wait_for_prompt()&#39;</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">()</span> <span class="c1"># Makes capturing just what we need easier</span>
    <span class="n">getoutput</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">get_cmd_output</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">OUTPUT_MATCH</span><span class="p">,</span>
        <span class="n">getoutput</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">errorback</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1"># Run our command immediately followed by our separation/ready string</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">writeline</span><span class="p">((</span>
        <span class="s1">u&#39;echo -e &quot;{rs}&quot;; &#39;</span> <span class="c1"># Echo the first READY_STRING</span>
        <span class="s1">u&#39;{cmd}; &#39;</span> <span class="c1"># Execute the command in question</span>
        <span class="s1">u&#39;echo -e &quot;{rs}&quot;&#39;</span> <span class="c1"># READY_STRING again so we can capture the between</span>
    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rs</span><span class="o">=</span><span class="n">READY_STRING</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">))</span></div>

<div class="viewcode-block" id="get_cmd_output"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_cmd_output">[docs]</a><span class="k">def</span> <span class="nf">get_cmd_output</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">matched</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Captures the output of the command executed inside of</span>
<span class="sd">    :func:`wait_for_prompt` and calls *callback* if it isn&#39;t `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get_cmd_output()&#39;</span><span class="p">)</span>
    <span class="n">cmd_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()]</span>
    <span class="n">capture</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cmd_out</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">capture</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">READY_STRING</span><span class="p">):</span>
            <span class="n">capture</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">capture</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">READY_STRING</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="c1"># This is just a silly trick to get the shell timing out/terminating itself</span>
    <span class="c1"># after a timout (so we don&#39;t keep the sub-channel open forever).  It is</span>
    <span class="c1"># easier than starting a timeout thread, timer, IOLoop.add_timeout(), etc</span>
    <span class="c1"># (I tried all those and it seemed to result in m_instance never getting</span>
    <span class="c1"># cleaned up properly by the garbage collector--it would leak memory)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">unexpect</span><span class="p">()</span> <span class="c1"># Clear out any existing patterns (i.e. keepalive ;)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span> <span class="c1"># Add our inactivity timeout</span>
        <span class="s2">&quot;^SUB-CHANNEL INACTIVITY TIMEOUT$&quot;</span><span class="p">,</span> <span class="c1"># ^ and $ to prevent accidents ;)</span>
        <span class="n">noop</span><span class="p">,</span> <span class="c1"># Don&#39;t need to do anything since this should never match</span>
        <span class="n">errorback</span><span class="o">=</span><span class="n">timeout_sub_channel</span><span class="p">,</span>
        <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">SUBCHANNEL_TIMEOUT</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="c1"># To ensure the timeout occurs</span>
    <span class="n">cmd_out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">cmd_out</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="terminate_sub_channel"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.terminate_sub_channel">[docs]</a><span class="k">def</span> <span class="nf">terminate_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls `m_instance.terminate()` and deletes it from `OPEN_SUBCHANNELS`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Closing SSH sub-channel&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">m_instance</span><span class="o">.</span><span class="n">term_id</span><span class="p">)})</span>
    <span class="k">global</span> <span class="n">OPEN_SUBCHANNELS</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="c1"># Find the Multiplex object inside of OPEN_SUBCHANNELS and remove it</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">OPEN_SUBCHANNELS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># This will be something like: {1: &lt;Multiplex instance&gt;}</span>
        <span class="k">if</span> <span class="nb">hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
            <span class="c1"># This is necessary so the interpreter can properly collect garbage:</span>
            <span class="k">del</span> <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="timeout_sub_channel"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.timeout_sub_channel">[docs]</a><span class="k">def</span> <span class="nf">timeout_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when the sub-channel times out by way of an</span>
<span class="sd">    :class:`termio.Multiplex.expect` pattern that should never match anything.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;SSH sub-channel closed due to inactivity.&quot;</span><span class="p">),</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">m_instance</span><span class="o">.</span><span class="n">term_id</span><span class="p">)})</span>
    <span class="n">terminate_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">)</span></div>

<div class="viewcode-block" id="got_error"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.got_error">[docs]</a><span class="k">def</span> <span class="nf">got_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called if :func:`execute_command` encounters a problem/timeout.</span>

<span class="sd">    *match* is here in case we want to use it for a positive match of an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Got an error trying to capture output inside of &quot;</span>
        <span class="s2">&quot;execute_command() running: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m_instance</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">cmd</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;output before error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>
    <span class="n">terminate_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;terminal:sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s1">&#39;Error: Timeout exceeded or command failed to execute.&#39;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="execute_command"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.execute_command">[docs]</a><span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the given command (*cmd*) on the given *term* using the existing</span>
<span class="sd">    SSH tunnel (taking advantage of `Master mode &lt;http://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing&gt;`_)</span>
<span class="sd">    and call *callback* with the output of said command and the current</span>
<span class="sd">    :class:`termio.Multiplex` instance as arguments like so::</span>

<span class="sd">        callback(output, m_instance)</span>

<span class="sd">    If *callback* is not provided then the command will be executed and any</span>
<span class="sd">    output will be ignored.</span>

<span class="sd">    .. note:: This will not result in a new terminal being opened on the client--it simply executes a command and returns the result using the existing SSH tunnel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Executing command on SSH sub-channel: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">open_sub_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SSHMultiplexingException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Got an error trying to open sub-channel on term </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">],</span> <span class="n">term</span><span class="p">)))</span>
        <span class="c1"># Try to send an error response to the client</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;terminal:sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># This is really just a last-ditch thing</span>
            <span class="k">pass</span>
        <span class="k">return</span>
    <span class="c1"># NOTE: We can assume the IOLoop is started and automatically calling read()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">unexpect</span><span class="p">()</span> <span class="c1"># Clear out any existing patterns (if existing sub-channel)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">()</span> <span class="c1"># Clear the screen so nothing mucks up our regexes</span>
    <span class="c1"># Check to make sure we&#39;ve got a proper prompt by executing an echo</span>
    <span class="c1"># statement and waiting for it to complete.  This is more reliable than</span>
    <span class="c1"># using a regular expression to match a shell prompt (which could be set</span>
    <span class="c1"># to anything).  It also gives us a clear indication as to where the command</span>
    <span class="c1"># output begins and ends.</span>
    <span class="n">errorback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">got_error</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">wait</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">wait_for_prompt</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">READY_MATCH</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">errorback</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for READY_MATCH inside execute_command()&quot;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s1">u&#39;echo -e &quot;</span><span class="se">\\</span><span class="s1">n</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">READY_STRING</span><span class="p">)</span></div>

<div class="viewcode-block" id="send_result"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.send_result">[docs]</a><span class="k">def</span> <span class="nf">send_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`ws_exec_command` when the output of the executed command</span>
<span class="sd">    has been captured successfully.  Writes a message to the client with the</span>
<span class="sd">    command&#39;s output and some relevant metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
            <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="ws_exec_command"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.ws_exec_command">[docs]</a><span class="k">def</span> <span class="nf">ws_exec_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes the necessary variables from *settings* and calls :func:`execute_command`.</span>

<span class="sd">    *settings* should be a dict that contains a &#39;term&#39; and a &#39;cmd&#39; to execute.</span>

<span class="sd">    .. tip:: This function can be used to quickly execute a command and return its result from the client over an existing SSH connection without requiring the user to enter their password!  See execRemoteCmd() in ssh.js.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]</span>
    <span class="n">send</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">send_result</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SSHExecutionException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;terminal:sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="s1">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<span class="c1"># Handlers</span>
<span class="c1">#class KnownHostsHandler(BaseHandler):</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1">#This handler allows the client to view, edit, and upload the known_hosts</span>
    <span class="c1">#file associated with their user account.</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1">#@tornado.web.authenticated</span>
    <span class="c1">#def get(self):</span>
        <span class="c1">#&quot;&quot;&quot;</span>
        <span class="c1">#Determine what the user is asking for and call the appropriate method.</span>
        <span class="c1">#&quot;&quot;&quot; # NOTE: Just dealing with known_hosts for now but keys are next</span>
        <span class="c1">#get_kh = self.get_argument(&#39;known_hosts&#39;, None)</span>
        <span class="c1">#if get_kh:</span>
            <span class="c1">#self._return_known_hosts()</span>

    <span class="c1">#@tornado.web.authenticated</span>
    <span class="c1">#def post(self):</span>
        <span class="c1">#&quot;&quot;&quot;</span>
        <span class="c1">#Determine what the user is updating by checking the given arguments and</span>
        <span class="c1">#proceed with the update.</span>
        <span class="c1">#&quot;&quot;&quot;</span>
        <span class="c1">#known_hosts = self.get_argument(&#39;known_hosts&#39;, None)</span>
        <span class="c1">#if known_hosts:</span>
            <span class="c1">#kh = self.request.body</span>
            <span class="c1">#self._save_known_hosts(kh)</span>

    <span class="c1">#def _return_known_hosts(self):</span>
        <span class="c1">#&quot;&quot;&quot;Returns the user&#39;s known_hosts file in text/plain format.&quot;&quot;&quot;</span>
        <span class="c1">#user = self.current_user[&#39;upn&#39;]</span>
        <span class="c1">#ssh_log.debug(&quot;known_hosts requested by %s&quot; % user)</span>
        <span class="c1">#users_dir = os.path.join(self.settings[&#39;user_dir&#39;], user) # &quot;User&#39;s dir&quot;</span>
        <span class="c1">#users_ssh_dir = os.path.join(users_dir, &#39;.ssh&#39;)</span>
        <span class="c1">#kh_path = os.path.join(users_ssh_dir, &#39;known_hosts&#39;)</span>
        <span class="c1">#known_hosts = &quot;&quot;</span>
        <span class="c1">#if os.path.exists(kh_path):</span>
            <span class="c1">#known_hosts = open(kh_path).read()</span>
        <span class="c1">#self.set_header (&#39;Content-Type&#39;, &#39;text/plain&#39;)</span>
        <span class="c1">#self.write(known_hosts)</span>

    <span class="c1">#def _save_known_hosts(self, known_hosts):</span>
        <span class="c1">#&quot;&quot;&quot;Save the given *known_hosts* file.&quot;&quot;&quot;</span>
        <span class="c1">#print(&quot;known_hosts: %s&quot; % known_hosts)</span>
        <span class="c1">#user = self.current_user[&#39;upn&#39;]</span>
        <span class="c1">#users_dir = os.path.join(self.settings[&#39;user_dir&#39;], user) # &quot;User&#39;s dir&quot;</span>
        <span class="c1">#users_ssh_dir = os.path.join(users_dir, &#39;.ssh&#39;)</span>
        <span class="c1">#if not os.path.isdir(users_ssh_dir): # Make .ssh dir if not present</span>
            <span class="c1">#mkdir_p(users_ssh_dir)</span>
            <span class="c1">#os.chmod(users_ssh_dir, 0o700)</span>
        <span class="c1">#kh_path = os.path.join(users_ssh_dir, &#39;known_hosts&#39;)</span>
        <span class="c1">## Letting Tornado&#39;s exception handler deal with errors here</span>
        <span class="c1">#with io.open(kh_path, &#39;wb&#39;) as f:</span>
            <span class="c1">#print(&quot;Writing known hosts: %s&quot; % kh_path)</span>
            <span class="c1">#f.write(known_hosts)</span>
        <span class="c1">#self.write(&quot;success&quot;)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">WebSocket Commands</span>
<span class="sd">------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># WebSocket commands (not the same as handlers)</span>
<div class="viewcode-block" id="get_known_hosts"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_known_hosts">[docs]</a><span class="k">def</span> <span class="nf">get_known_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attached to the (server-side) `terminal:ssh_get_known_hosts` WebSocket</span>
<span class="sd">    action; returns the current user&#39;s known_hosts file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;known_hosts requested by </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c1"># &quot;User&#39;s dir&quot;</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s1">&#39;.ssh&#39;</span><span class="p">)</span>
    <span class="n">kh_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s1">&#39;known_hosts&#39;</span><span class="p">)</span>
    <span class="n">known_hosts</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">kh_path</span><span class="p">):</span>
        <span class="n">known_hosts</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">kh_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:sshjs_known_hosts&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;known_hosts&#39;</span><span class="p">:</span> <span class="n">known_hosts</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="save_known_hosts"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.save_known_hosts">[docs]</a><span class="k">def</span> <span class="nf">save_known_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">known_hosts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attached to the (server-side) `terminal:ssh_save_known_hosts` WebSocket</span>
<span class="sd">    action; saves the given *known_hosts* (string) to the user&#39;s known_hosts</span>
<span class="sd">    file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;known_hosts updated by </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c1"># &quot;User&#39;s dir&quot;</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s1">&#39;.ssh&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">):</span> <span class="c1"># Make .ssh dir if not present</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
    <span class="n">kh_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s1">&#39;known_hosts&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">kh_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">known_hosts</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Exception trying to save known_hosts file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">ssh_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;An error was encountered trying to save the known_hosts file.  &quot;</span>
            <span class="s2">&quot;See server logs for details.&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="get_connect_string"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_connect_string">[docs]</a><span class="k">def</span> <span class="nf">get_connect_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attached to the (server-side) `terminal:ssh_get_connect_string` WebSocket</span>
<span class="sd">    action; writes the connection string associated with *term* to the WebSocket</span>
<span class="sd">    like so::</span>

<span class="sd">        {&#39;terminal:sshjs_reconnect&#39;: {*term*: &lt;connection string&gt;}}</span>

<span class="sd">    In ssh.js we attach a WebSocket action to &#39;terminal:sshjs_reconnect&#39;</span>
<span class="sd">    that assigns the connection string sent by this function to</span>
<span class="sd">    `GateOne.Terminal.terminals[*term*][&#39;sshConnectString&#39;]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This is the first function that normally gets called when a user uses SSH</span>
    <span class="c1"># so it&#39;s a good time to update the logger with extra metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span>
        <span class="s2">&quot;gateone.terminal.ssh&quot;</span><span class="p">,</span> <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span><span class="p">)</span>
    <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
        <span class="k">return</span> <span class="c1"># Nothing to do (already closed)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;get_connect_string()&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">})</span>
    <span class="n">connect_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ssh_connect_string&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connect_string</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;terminal:sshjs_reconnect&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="s1">&#39;connect_string&#39;</span><span class="p">:</span> <span class="n">connect_string</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_key"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_key">[docs]</a><span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">public</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the private SSH key associated with *name* to the client.  If</span>
<span class="sd">    *public* is `True`, returns the public key to the client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s1">&#39;SSH Plugin Error: Invalid name given, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:save_file&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">public</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pub&#39;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;.pub&#39;</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="c1"># Yet</span>
        <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span>
    <span class="p">}</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Success&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s1">&#39;SSH Plugin Error: Public key not found at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key_path</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go:save_file&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_dict</span></div>

<div class="viewcode-block" id="get_public_key"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_public_key">[docs]</a><span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the user&#39;s public key file named *name*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_private_key"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_private_key">[docs]</a><span class="k">def</span> <span class="nf">get_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the user&#39;s private key file named *name*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_host_fingerprint"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_host_fingerprint">[docs]</a><span class="k">def</span> <span class="nf">get_host_fingerprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a the hash of the given host&#39;s public key by making a remote</span>
<span class="sd">    connection to the server (not just by looking at known_hosts).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;port&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;host&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error:  You must supply a &#39;host&#39;.&quot;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:sshjs_display_fingerprint&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;get_host_fingerprint(</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">})</span>
    <span class="n">out_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span><span class="p">,</span>
        <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
        <span class="s1">&#39;fingerprint&#39;</span><span class="p">:</span> <span class="bp">None</span>
    <span class="p">})</span>
    <span class="n">ssh</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -p </span><span class="si">%s</span><span class="s2"> -oUserKnownHostsFile=none -F. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span>
        <span class="n">command</span><span class="p">,</span>
        <span class="s1">&#39;get_host_key&#39;</span><span class="p">,</span>
        <span class="n">logging</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># Logging is false so we don&#39;t make tons of silly logs</span>
    <span class="k">def</span> <span class="nf">grab_fingerprint</span><span class="p">(</span><span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;fingerprint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:sshjs_display_fingerprint&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">m_instance</span>
    <span class="k">def</span> <span class="nf">errorback</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
        <span class="n">leftovers</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Error: Could not determine the fingerprint of </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">... &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leftovers</span><span class="p">)))</span>
        <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span> <span class="c1"># Don&#39;t leave stuff hanging around!</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:sshjs_display_fingerprint&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">m_instance</span>
    <span class="c1"># &quot;The authenticity of host &#39;localhost (127.0.0.1)&#39; can&#39;t be established.\r\nECDSA key fingerprint is 83:f5:b1:f1:d3:8c:b8:fe:d3:be:e5:dd:95:a5:ba:73.\r\nAre you sure you want to continue connecting (yes/no)? &quot;</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">.+fingerprint .+</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">grab_fingerprint</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">errorback</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">()</span></div>
    <span class="c1"># OpenSSH output example:</span>
    <span class="c1"># ECDSA key fingerprint is 28:46:86:3a:c6:f9:63:b8:90:e1:09:69:f2:1d:c8:ce.</span>
    <span class="c1"># Dropbear output example:</span>
    <span class="c1"># (fingerprint md5 fa:a1:5b:4f:e5:ab:fe:e6:1f:1f:74:20:d7:35:67:c2)</span>

<div class="viewcode-block" id="generate_new_keypair"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.generate_new_keypair">[docs]</a><span class="k">def</span> <span class="nf">generate_new_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls :func:`openssh_generate_new_keypair` or</span>
<span class="sd">    :func:`dropbear_generate_new_keypair` depending on what&#39;s available on the</span>
<span class="sd">    system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;generate_new_keypair()&#39;</span><span class="p">)</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;id_ecdsa&#39;</span>
    <span class="n">keytype</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">passphrase</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;keytype&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">keytype</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;keytype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;bits&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bits&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;passphrase&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">passphrase</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;passphrase&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;comment&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span>
    <span class="n">log_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;keytype&#39;</span><span class="p">:</span> <span class="n">keytype</span><span class="p">,</span>
        <span class="s1">&#39;bits&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">,</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating new SSH keypair&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">log_metadata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ssh-keygen&#39;</span><span class="p">):</span> <span class="c1"># Prefer OpenSSH</span>
        <span class="n">openssh_generate_new_keypair</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span> <span class="c1"># Name to use when generating the keypair</span>
            <span class="n">users_ssh_dir</span><span class="p">,</span> <span class="c1"># Path to save it</span>
            <span class="n">keytype</span><span class="o">=</span><span class="n">keytype</span><span class="p">,</span>
            <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">,</span>
            <span class="n">bits</span><span class="o">=</span><span class="n">bits</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;dropbearkey&#39;</span><span class="p">):</span>
        <span class="n">dropbear_generate_new_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span> <span class="c1"># Name to use when generating the keypair</span>
            <span class="n">users_ssh_dir</span><span class="p">,</span> <span class="c1"># Path to save it</span>
            <span class="n">keytype</span><span class="o">=</span><span class="n">keytype</span><span class="p">,</span>
            <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">,</span>
            <span class="n">bits</span><span class="o">=</span><span class="n">bits</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">errorback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Keypair generation failed.&quot;</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:sshjs_keygen_complete&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;There was a problem generating SSH keys: </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">()),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="overwrite"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.overwrite">[docs]</a><span class="k">def</span> <span class="nf">overwrite</span><span class="p">(</span><span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called if we get asked to overwrite an existing keypair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;overwrite()&#39;</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">enter_passphrase</span><span class="p">(</span><span class="n">passphrase</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
    <span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;entering passphrase...&quot;</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">passphrase</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Keypair generation complete&quot;</span><span class="p">),</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fingerprint&#39;</span><span class="p">:</span> <span class="n">fingerprint</span><span class="p">})</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:sshjs_keygen_complete&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fingerprint&#39;</span><span class="p">:</span> <span class="n">fingerprint</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="openssh_generate_new_keypair"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.openssh_generate_new_keypair">[docs]</a><span class="k">def</span> <span class="nf">openssh_generate_new_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
        <span class="n">keytype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a new private and public key pair--stored in the user&#39;s directory</span>
<span class="sd">    using the given *name* and other optional parameters (using OpenSSH).</span>

<span class="sd">    If *keytype* is given, it must be one of &quot;ecdsa&quot;, &quot;rsa&quot; or &quot;dsa&quot; (case</span>
<span class="sd">    insensitive).  If *keytype* is &quot;rsa&quot; or &quot;ecdsa&quot;, *bits* may be specified to</span>
<span class="sd">    specify the size of the key.</span>

<span class="sd">    .. note:: Defaults to generating a 521-byte ecdsa key if OpenSSH is version 5.7+. Otherwise a 2048-bit rsa key will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;openssh_generate_new_keypair()&#39;</span><span class="p">)</span>
    <span class="n">openssh_version</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="s1">&#39;ssh -V&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ssh_major_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">openssh_version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">ssh_minor_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">openssh_version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ssh_version</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh_major_version</span><span class="p">,</span> <span class="n">ssh_minor_version</span><span class="p">)</span>
    <span class="n">ssh_version</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ssh_version</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keytype</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ssh_version</span> <span class="o">&gt;=</span> <span class="mf">5.7</span><span class="p">:</span>
            <span class="n">keytype</span> <span class="o">=</span> <span class="s2">&quot;ecdsa&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keytype</span> <span class="o">=</span> <span class="s2">&quot;rsa&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keytype</span> <span class="o">=</span> <span class="n">keytype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bits</span> <span class="ow">and</span> <span class="n">keytype</span> <span class="o">==</span> <span class="s2">&quot;ecdsa&quot;</span><span class="p">:</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="mi">521</span> <span class="c1"># Not a typo: five-hundred-twenty-one bits</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">bits</span> <span class="ow">and</span> <span class="n">keytype</span> <span class="o">==</span> <span class="s2">&quot;rsa&quot;</span><span class="p">:</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">passphrase</span><span class="p">:</span> <span class="c1"># This just makes sure False and None end up as &#39;&#39;</span>
        <span class="n">passphrase</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Generated by Gate One on </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
    <span class="n">ssh_keygen_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ssh-keygen&#39;</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span>       <span class="c1"># Path to ssh-keygen</span>
        <span class="s2">&quot;-b </span><span class="si">%s</span><span class="s2"> &quot;</span>    <span class="c1"># bits</span>
        <span class="s2">&quot;-t </span><span class="si">%s</span><span class="s2"> &quot;</span>    <span class="c1"># keytype</span>
        <span class="s2">&quot;-C &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>  <span class="c1"># comment</span>
        <span class="s2">&quot;-f &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>   <span class="c1"># Key path</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">keytype</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">key_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Keygen command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s2">&quot;gen_ssh_keypair&quot;</span><span class="p">)</span>
    <span class="n">call_errorback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">errorback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;^Overwrite.*&#39;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">passphrase_handler</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">enter_passphrase</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;^Enter passphrase&#39;</span><span class="p">,</span>
        <span class="n">passphrase_handler</span><span class="p">,</span>
        <span class="n">errorback</span><span class="o">=</span><span class="n">call_errorback</span><span class="p">,</span>
        <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;^Enter same passphrase again&#39;</span><span class="p">,</span>
        <span class="n">passphrase_handler</span><span class="p">,</span>
        <span class="n">errorback</span><span class="o">=</span><span class="n">call_errorback</span><span class="p">,</span>
        <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">finalize</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="c1"># The regex below captures the md5 fingerprint which tells us the</span>
    <span class="c1"># operation was successful.</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span>
        <span class="s1">&#39;(([0-9a-f][0-9a-f]\:){15}[0-9a-f][0-9a-f])&#39;</span><span class="p">,</span>
        <span class="n">finalize</span><span class="p">,</span>
        <span class="n">errorback</span><span class="o">=</span><span class="n">call_errorback</span><span class="p">,</span>
        <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span> <span class="c1"># Key generation can take a little while</span>
    <span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">()</span></div>

<div class="viewcode-block" id="dropbear_generate_new_keypair"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.dropbear_generate_new_keypair">[docs]</a><span class="k">def</span> <span class="nf">dropbear_generate_new_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
        <span class="n">keytype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. note:: Not implemented yet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="openssh_generate_public_key"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.openssh_generate_public_key">[docs]</a><span class="k">def</span> <span class="nf">openssh_generate_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a public key from the given private key at *path*.  If a</span>
<span class="sd">    *passphrase* is provided, it will be used to generate the public key (if</span>
<span class="sd">    necessary).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;openssh_generate_public_key()&#39;</span><span class="p">)</span>
    <span class="n">ssh_keygen_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ssh-keygen&#39;</span><span class="p">)</span>
    <span class="n">pubkey_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.pub&quot;</span> <span class="o">%</span> <span class="n">path</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span>       <span class="c1"># Path to ssh-keygen</span>
        <span class="s2">&quot;-f &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>  <span class="c1"># Key path</span>
        <span class="s2">&quot;-y &quot;</span>       <span class="c1"># Output public key to stdout</span>
        <span class="s2">&quot;2&gt;&amp;1 &quot;</span>     <span class="c1"># Redirect stderr to stdout so we can catch failures</span>
        <span class="s2">&quot;&gt; &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>    <span class="c1"># Redirect stdout to the public key path</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pubkey_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="kn">import</span> <span class="nn">termio</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">termio</span><span class="o">.</span><span class="n">Multiplex</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">request_passphrase</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s2">&quot;Called if this key requires a passphrase.  Ask the client to provide&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:sshjs_ask_passphrase&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bad_passphrase</span><span class="p">(</span><span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="s2">&quot;Called if the user entered a bad passphrase&quot;</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">request_passphrase</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">passphrase</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;^Enter passphrase&#39;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">passphrase</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;^load failed&#39;</span><span class="p">,</span>
            <span class="n">bad_passphrase</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;^Enter passphrase&#39;</span><span class="p">,</span>
            <span class="n">request_passphrase</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">preprocess</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">atexit</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">exitstatus</span><span class="p">):</span>
        <span class="s2">&quot;Raises an SSHKeygenException if the *exitstatus* isn&#39;t 0&quot;</span>
        <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dump</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SSHKeygenException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Error generating public key from private key at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">))</span>
    <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">exitfunc</span><span class="o">=</span><span class="n">atexit</span><span class="p">)</span></div>
    <span class="c1">#exitstatus, output = shell_command(command)</span>
    <span class="c1">#if exitstatus != 0:</span>
        <span class="c1">#raise SSHKeygenException(_(</span>
            <span class="c1">#&quot;Error generating public key from private key at %s&quot; % path))</span>

<span class="c1"># ssh-kegen example for reference:</span>
    <span class="c1">#$ ssh-keygen -b 521 -t ecdsa &quot;Testing&quot; -f /tmp/testkey</span>
    <span class="c1">#Generating public/private ecdsa key pair.</span>
    <span class="c1">#Enter passphrase (empty for no passphrase):</span>
    <span class="c1">#Enter same passphrase again:</span>
    <span class="c1">#Your identification has been saved in /tmp/testkey.</span>
    <span class="c1">#Your public key has been saved in /tmp/testkey.pub.</span>
    <span class="c1">#The key fingerprint is:</span>
    <span class="c1">#6b:13:4b:5d:80:bd:21:70:33:f5:b9:15:78:75:08:9a Testing</span>
    <span class="c1">#The key&#39;s randomart image is:</span>
    <span class="c1">#+--[ECDSA  521]---+</span>
    <span class="c1">#|      ..++o .o.oo|</span>
    <span class="c1">#|       .ooo=..o..|</span>
    <span class="c1">#|         .Eo+..  |</span>
    <span class="c1">#|         ... o   |</span>
    <span class="c1">#|        S . .    |</span>
    <span class="c1">#|       . +       |</span>
    <span class="c1">#|        =        |</span>
    <span class="c1">#|       . .       |</span>
    <span class="c1">#|                 |</span>
    <span class="c1">#+-----------------+</span>

<span class="c1"># dropbearkey example for reference:</span>

    <span class="c1">#root@router:~# dropbearkey -t dss -f /tmp/testing</span>
    <span class="c1">#Will output 1024 bit dss secret key to &#39;/tmp/testing&#39;</span>
    <span class="c1">#Generating key, this may take a while...</span>
    <span class="c1">#Public key portion is:</span>
    <span class="c1">#ssh-dss AAAAB3NzaC1kc3MAAACBAJ5jU4izsZtJKEojw7gIcc6e3U4X6OENN6081YxSAanfTbKjR0V3Ho6aui2z8o039BVH4S5cVD51vEEvDjirKStM2aMvdrVZkjGH1iOMWY4MQrCl4EqMr7rWikeiZJN6BJ+xmPBUyZuicVDFkBwqC+dKgxml0RTpa7TYBWvp403XAAAAFQDg6vb3afaKM9+DvBW7I4xPxF8a8QAAAIEAjcNHYFrqcWK9lSsw2Oy+w1PEWQuxvWydXXk3MQyiZ/PYaeU/138iCB2pW1fgCksx5CHF8dgtQ7AsFv32gBlxuDgX3EYtPYR0wGJqyU7w9+qaq1T02zmDfW4k2WDfMNz+QWFYHuKzC/aeuEC0BRTLyPVQMHLNAd/F5beCqlIPRPcAAACAfUy1+yNgK2svox6aJRqtpxbMSPDRNTRMAjeTkCeLopesZFYbPvms2c19WkIk2qD9aw3gIxsR4wO+kkvI4BtOs8dXQWS+bc+svJbIYOqmPFo89BJHfbP9wvMhfTlp1uH9LxAG6ZiHHz5fseUgTrwYkSw1beUprikxlca8lQm5v7g= root@RouterStationPro</span>
    <span class="c1">#Fingerprint: md5 c6:f9:f2:95:b8:40:ac:f3:53:f1:39:e9:57:a0:58:18</span>

<span class="c1"># TODO: Get this validating uploaded keys.</span>
<div class="viewcode-block" id="store_id_file"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.store_id_file">[docs]</a><span class="k">def</span> <span class="nf">store_id_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores the given *settings[&#39;private&#39;]* and/or *settings[&#39;public&#39;]* keypair</span>
<span class="sd">    in the user&#39;s ssh directory as *settings[&#39;name&#39;]* and/or</span>
<span class="sd">    *settings[&#39;name&#39;]*.pub, respectively.  Either file can be saved independent</span>
<span class="sd">    of each other (in case this function needs to be called multiple times to</span>
<span class="sd">    save each respective file).</span>

<span class="sd">    Also, a *settings[&#39;certificate&#39;]* may be provided to be saved along</span>
<span class="sd">    with the private and public keys.  It will be saved as</span>
<span class="sd">    *settings[&#39;name&#39;]*-cert.pub.</span>

<span class="sd">    .. note::</span>

<span class="sd">        I&#39;ve found the following website helpful in understanding how to use</span>
<span class="sd">        OpenSSH with SSL certificates:</span>
<span class="sd">        http://blog.habets.pp.se/2011/07/OpenSSH-certificates</span>

<span class="sd">    .. tip::</span>

<span class="sd">        Using signed-by-a-CA certificates is very handy because allows you to</span>
<span class="sd">        revoke the user&#39;s SSH key(s).  e.g. If they left the company.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;store_id_file()&#39;</span><span class="p">)</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span><span class="p">}</span>
    <span class="k">global</span> <span class="n">TIMER</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHKeypairException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You must specify a valid *name*.&quot;</span><span class="p">))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Remove .txt, .pub, etc</span>
        <span class="n">private</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">public</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">certificate</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;certificate&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">passphrase</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;passphrase&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">private</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">public</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">certificate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHKeypairException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No files were given to save!&quot;</span><span class="p">))</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">private_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># Strip any .pub or .txt from the end of the public key</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pub&#39;</span><span class="p">):</span>
            <span class="n">public_key_name</span> <span class="o">=</span> <span class="n">name</span> <span class="c1"># Get rid of the extra .pub</span>
        <span class="n">public_key_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pub&#39;</span>
        <span class="n">public_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">public_key_name</span><span class="p">)</span>
        <span class="n">certificate_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cert.pub&#39;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-cert.pub&#39;</span><span class="p">):</span>
            <span class="n">certificate_name</span> <span class="o">=</span> <span class="n">name</span> <span class="c1"># Don&#39;t need an extra -cert.pub at the end</span>
        <span class="n">certificate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">certificate_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private</span><span class="p">:</span>
            <span class="c1"># Fix Windows newlines</span>
            <span class="n">private</span> <span class="o">=</span> <span class="n">private</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">VALID_PRIVATE_KEY</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">private</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">private</span><span class="p">)</span>
                <span class="c1"># Without this you get a warning:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">,</span> <span class="mi">0</span><span class="n">o600</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">({</span><span class="s1">&#39;go:notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;ERROR: Private key is not valid.&quot;</span><span class="p">)})</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">public</span><span class="p">:</span>
            <span class="c1"># Fix Windows newlines</span>
            <span class="n">public</span> <span class="o">=</span> <span class="n">public</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">public_key_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">public</span><span class="p">)</span>
            <span class="c1"># Now remove the timer that will generate the public key from the</span>
            <span class="c1"># private key if it is set.</span>
            <span class="k">if</span> <span class="n">TIMER</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Got public key, cancelling public key generation timer.&quot;</span><span class="p">))</span>
                <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
                <span class="n">io_loop</span><span class="o">.</span><span class="n">remove_timeout</span><span class="p">(</span><span class="n">TIMER</span><span class="p">)</span>
                <span class="n">TIMER</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">get_ids</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">get_identities</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">get_ids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">private</span><span class="p">:</span> <span class="c1"># No biggie, generate one</span>
            <span class="c1"># Only generate a new public key if one isn&#39;t uploaded within 2</span>
            <span class="c1"># seconds (should be plenty of time since they&#39;re typically sent</span>
            <span class="c1"># simultaneously but inside different WebSocket messages).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Only received a private key.  Setting timeout to generate the &quot;</span>
                <span class="s2">&quot;public key if not received within 3 seconds.&quot;</span><span class="p">))</span>
            <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">generate_public_key</span><span class="p">():</span> <span class="c1"># I love closures</span>
                <span class="n">openssh_generate_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">private_key_path</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                <span class="n">get_ids</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">get_identities</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">get_ids</span><span class="p">)</span>
            <span class="c1"># This gets removed if the public key is uploaded</span>
            <span class="n">TIMER</span> <span class="o">=</span> <span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="n">generate_public_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">certificate</span><span class="p">:</span>
            <span class="c1"># Fix Windows newlines</span>
            <span class="n">certificate</span> <span class="o">=</span> <span class="n">certificate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error saving keys: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:sshjs_save_id_complete&#39;</span><span class="p">:</span> <span class="n">out_dict</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="delete_identity"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.delete_identity">[docs]</a><span class="k">def</span> <span class="nf">delete_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the identity associated with *name*.  For example if *name* is</span>
<span class="sd">    &#39;testkey&#39;, &#39;testkey&#39; and &#39;testkey.pub&#39; would be removed from the user&#39;s</span>
<span class="sd">    ssh directory (and &#39;testkey-cert.pub&#39; if present).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Deleting SSH identity: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span><span class="p">}</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">private_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">public_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.pub&#39;</span><span class="p">)</span>
    <span class="n">certificate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;-cert.pub&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">public_key_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">public_key_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error deleting keypair: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:sshjs_delete_identity_complete&#39;</span><span class="p">:</span> <span class="n">out_dict</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_identities"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.get_identities">[docs]</a><span class="k">def</span> <span class="nf">get_identities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">anything</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends a message to the client with a list of the identities stored on the</span>
<span class="sd">    server for the current user.</span>

<span class="sd">    *anything* is just there because the client needs to send *something* along</span>
<span class="sd">    with the &#39;action&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get_identities()&#39;</span><span class="p">)</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Success&#39;</span><span class="p">}</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;identities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ssh_keygen_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ssh-keygen&#39;</span><span class="p">)</span>
    <span class="c1"># TODO:  Switch this from using ssh-keygen to determine the keytype to using the string inside the public key.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">):</span>
            <span class="n">ssh_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ssh_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pub&#39;</span><span class="p">):</span>
                    <span class="c1"># Double-check there&#39;s also a private key...</span>
                    <span class="n">identity</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># Will be the same name minus &#39;.pub&#39;</span>
                    <span class="k">if</span> <span class="n">identity</span> <span class="ow">in</span> <span class="n">ssh_files</span><span class="p">:</span>
                        <span class="n">id_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>
                        <span class="n">pub_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="n">public_key_contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pub_key_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">public_key_contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="n">public_key_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ecdsa&#39;</span><span class="p">):</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s1">&#39;ECDSA&#39;</span>
                        <span class="k">elif</span> <span class="n">public_key_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ssh-dss&#39;</span><span class="p">):</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s1">&#39;DSA&#39;</span>
                        <span class="k">elif</span> <span class="n">public_key_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ssh-rsa&#39;</span><span class="p">):</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s1">&#39;RSA&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
                        <span class="n">keygen_cmd</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; -vlf &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">id_path</span><span class="p">)</span>
                        <span class="n">retcode</span><span class="p">,</span> <span class="n">key_info</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">keygen_cmd</span><span class="p">)</span>
                        <span class="c1"># This will just wind up as an empty string if the</span>
                        <span class="c1"># version of ssh doesn&#39;t support randomart:</span>
                        <span class="n">randomart</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_info</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">bits</span> <span class="o">=</span> <span class="n">key_info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">key_info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">retcode</span><span class="p">,</span> <span class="n">bubblebabble</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span>
                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; -Bf &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">id_path</span><span class="p">))</span>
                        <span class="n">bubblebabble</span> <span class="o">=</span> <span class="n">bubblebabble</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">certinfo</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">cert_path</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">-cert.pub&#39;&quot;</span> <span class="o">%</span> <span class="n">id_path</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_path</span><span class="p">):</span>
                            <span class="n">retcode</span><span class="p">,</span> <span class="n">certinfo</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span>
                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; -Lf &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">cert_path</span><span class="p">))</span>
                        <span class="n">certinfo</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">certinfo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">fixed_certinfo</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">certinfo</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                            <span class="n">fixed_certinfo</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                            <span class="n">fixed_certinfo</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="n">id_obj</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">identity</span><span class="p">,</span>
                            <span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="n">public_key_contents</span><span class="p">,</span>
                            <span class="s1">&#39;keytype&#39;</span><span class="p">:</span> <span class="n">keytype</span><span class="p">,</span>
                            <span class="s1">&#39;bubblebabble&#39;</span><span class="p">:</span> <span class="n">bubblebabble</span><span class="p">,</span>
                            <span class="s1">&#39;fingerprint&#39;</span><span class="p">:</span> <span class="n">fingerprint</span><span class="p">,</span>
                            <span class="s1">&#39;randomart&#39;</span><span class="p">:</span> <span class="n">randomart</span><span class="p">,</span>
                            <span class="s1">&#39;certinfo&#39;</span><span class="p">:</span> <span class="n">fixed_certinfo</span><span class="p">,</span>
                            <span class="s1">&#39;bits&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">,</span>
                            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span>
                        <span class="p">}</span>
                        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;identities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_obj</span><span class="p">)</span>
        <span class="c1"># Figure out which identities are defaults</span>
        <span class="n">default_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">default_ids_exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">default_ids_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s1">&#39;.default_ids&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">default_ids_path</span><span class="p">):</span>
            <span class="n">default_ids_exists</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_ids_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">default_ids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="c1"># Why not readlines()? \n</span>
        <span class="c1"># Convert any absolute paths inside default_ids to just the short names</span>
        <span class="n">default_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">default_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">default_ids_exists</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">id_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;identities&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">id_obj</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">default_ids</span><span class="p">:</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;identities&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;identities&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error getting identities: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:sshjs_identities_list&#39;</span><span class="p">:</span> <span class="n">out_dict</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="set_default_identities"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.set_default_identities">[docs]</a><span class="k">def</span> <span class="nf">set_default_identities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identities</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of *identities*, mark them as defaults to use in all outbound</span>
<span class="sd">    SSH connections by writing them to `&lt;user&#39;s ssh dir&gt;/.default_ids`.  If</span>
<span class="sd">    *identities* is empty, no identities will be used in outbound connections.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Whenever this function is called it will overwrite whatever is in</span>
<span class="sd">        `.default_ids`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">identities</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># Ignore anything else</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">default_ids_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s1">&#39;.default_ids&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_ids_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">identities</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># Need that trailing newline</span></div>

<div class="viewcode-block" id="set_ssh_socket"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.set_ssh_socket">[docs]</a><span class="k">def</span> <span class="nf">set_ssh_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a *term* and *path*, sets</span>
<span class="sd">    ``self.loc_terms[term][&#39;ssh_socket&#39;] = path``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set_ssh_socket(): </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
    <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;ssh_socket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ssh_socket&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span></div>

<div class="viewcode-block" id="set_ssh_connect_string"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.set_ssh_connect_string">[docs]</a><span class="k">def</span> <span class="nf">set_ssh_connect_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">connect_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a *term* and *connect_string*, sets</span>
<span class="sd">    ``self.loc_terms[term][&#39;ssh_connect_string&#39;] = connect_string``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;set_ssh_connect_string: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">connect_string</span><span class="p">))</span>
    <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_terms</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="s1">&#39;ssh_connect_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connect_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_term_settings</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ssh_connect_string&#39;</span><span class="p">:</span> <span class="n">connect_string</span><span class="p">})</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;terminal:sshjs_connect&#39;</span><span class="p">:</span> <span class="n">connect_string</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<span class="c1"># Special optional escape sequence handler (see docs on how it works)</span>
<div class="viewcode-block" id="opt_esc_handler"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.opt_esc_handler">[docs]</a><span class="k">def</span> <span class="nf">opt_esc_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">multiplex</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles text passed from the special optional escape sequance handler.  We</span>
<span class="sd">    use it to tell ssh.js what the SSH connection string is so it can use that</span>
<span class="sd">    information to duplicate sessions (if the user so desires).  For reference,</span>
<span class="sd">    the specific string which will call this function from a terminal app is::</span>

<span class="sd">        \\x1b]_;ssh|&lt;whatever&gt;\\x07</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :class:`gateone.TerminalWebSocket.esc_opt_handler` and</span>
<span class="sd">        :func:`terminal.Terminal._opt_handler`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supported_assignments</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ssh_socket&#39;</span><span class="p">:</span> <span class="n">set_ssh_socket</span><span class="p">,</span>
        <span class="s1">&#39;connect_string&#39;</span><span class="p">:</span> <span class="n">set_ssh_connect_string</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;set;&#39;</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">assignment</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">supported_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="create_user_ssh_dir"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.create_user_ssh_dir">[docs]</a><span class="k">def</span> <span class="nf">create_user_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To be called by the &#39;Auth&#39; hook that gets called after the user is done</span>
<span class="sd">    authenticating, ensures that the `&lt;user&#39;s dir&gt;/ssh` directory exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;create_user_ssh_dir()&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;upn&#39;</span><span class="p">]</span>
    <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c1"># &quot;User&#39;s dir&quot;</span>
    <span class="n">ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s1">&#39;.ssh&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">ssh_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error creating user&#39;s ssh directory: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="send_ssh_css_template"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.send_ssh_css_template">[docs]</a><span class="k">def</span> <span class="nf">send_ssh_css_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends our ssh.css template to the client using the &#39;load_style&#39;</span>
<span class="sd">    WebSocket action.  The rendered template will be saved in Gate One&#39;s</span>
<span class="sd">    &#39;cache_dir&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">css_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PLUGIN_PATH</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh.css&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">render_and_send_css</span><span class="p">(</span><span class="n">css_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="initialize"><a class="viewcode-back" href="../Applications/terminal/plugin_ssh.html#ssh.initialize">[docs]</a><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called inside of :meth:`TerminalApplication.initialize` shortly after the</span>
<span class="sd">    WebSocket is instantiated.  Attaches our two `terminal:authenticate` events</span>
<span class="sd">    (to create the user&#39;s .ssh dir and send our CSS template) and ensures that</span>
<span class="sd">    the ssh_connect.py script is executable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssh_connect_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PLUGIN_PATH</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_connect.py&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ssh_connect_path</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">stat</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">ssh_connect_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">ssh_connect_path</span><span class="p">,</span> <span class="mi">0</span><span class="n">o755</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">ssh_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Could not set </span><span class="si">%s</span><span class="s2"> as executable.  You will need to &#39;chmod &quot;</span>
                    <span class="s2">&quot;a+x&#39; that script manually.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">ssh_connect_path</span><span class="p">)</span>
                <span class="n">user_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Error loading SSH plugin:  The ssh_connect.py script is &quot;</span>
                    <span class="s2">&quot;not executable.  See the logs for more details.&quot;</span><span class="p">)</span>
                <span class="n">send_msg</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_message</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">)</span>
                <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;terminal:authenticate&quot;</span><span class="p">,</span> <span class="s2">&quot;terminal:new_terminal&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">send_msg</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ssh_log</span> <span class="o">=</span> <span class="n">go_logger</span><span class="p">(</span><span class="s2">&quot;gateone.terminal.ssh&quot;</span><span class="p">,</span> <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="c1"># NOTE:  Why not use the &#39;Events&#39; hook for these?  You can&#39;t attach two</span>
    <span class="c1"># functions to the same event via that mechanism because it&#39;s a dict</span>
    <span class="c1"># (one would override the other).</span>
    <span class="c1"># An alternative would be to write a single function say, on_auth() that</span>
    <span class="c1"># calls both of these functions then assign it to &#39;terminal:authenticate&#39; in</span>
    <span class="c1"># the &#39;Events&#39; hook.  I think this way is better since it is more explicit.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;terminal:authenticate&#39;</span><span class="p">,</span> <span class="n">bind</span><span class="p">(</span><span class="n">send_ssh_css_template</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;terminal:authenticate&#39;</span><span class="p">,</span> <span class="n">bind</span><span class="p">(</span><span class="n">create_user_ssh_dir</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span></div>

<span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">#&#39;Web&#39;: [(r&quot;/ssh&quot;, KnownHostsHandler)],</span>
    <span class="s1">&#39;WebSocket&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;terminal:ssh_get_known_hosts&#39;</span><span class="p">:</span> <span class="n">get_known_hosts</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_save_known_hosts&#39;</span><span class="p">:</span> <span class="n">save_known_hosts</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_get_connect_string&#39;</span><span class="p">:</span> <span class="n">get_connect_string</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_execute_command&#39;</span><span class="p">:</span> <span class="n">ws_exec_command</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_get_identities&#39;</span><span class="p">:</span> <span class="n">get_identities</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_get_public_key&#39;</span><span class="p">:</span> <span class="n">get_public_key</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_get_private_key&#39;</span><span class="p">:</span> <span class="n">get_private_key</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_get_host_fingerprint&#39;</span><span class="p">:</span> <span class="n">get_host_fingerprint</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_gen_new_keypair&#39;</span><span class="p">:</span> <span class="n">generate_new_keypair</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_store_id_file&#39;</span><span class="p">:</span> <span class="n">store_id_file</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_delete_identity&#39;</span><span class="p">:</span> <span class="n">delete_identity</span><span class="p">,</span>
        <span class="s1">&#39;terminal:ssh_set_default_identities&#39;</span><span class="p">:</span> <span class="n">set_default_identities</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;Escape&#39;</span><span class="p">:</span> <span class="n">opt_esc_handler</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Certificate information (as output by ssh-keygen) for reference:</span>
<span class="c1">#</span>
<span class="c1">#$ ssh-keygen -Lf id_rsa-cert.pub</span>
<span class="c1">#id_rsa-cert.pub:</span>
        <span class="c1">#Type: ssh-rsa-cert-v01@openssh.com user certificate</span>
        <span class="c1">#Public key: RSA-CERT 80:57:2c:18:f9:86:ab:8b:64:27:db:6f:5e:03:3f:d9</span>
        <span class="c1">#Signing CA: RSA 86:25:b0:73:67:0f:51:2e:a7:96:63:08:fb:d6:69:94</span>
        <span class="c1">#Key ID: &quot;user_riskable&quot;</span>
        <span class="c1">#Serial: 0</span>
        <span class="c1">#Valid: from 2012-01-08T13:38:00 to 2013-01-06T13:39:27</span>
        <span class="c1">#Principals:</span>
                <span class="c1">#riskable</span>
        <span class="c1">#Critical Options: (none)</span>
        <span class="c1">#Extensions:</span>
                <span class="c1">#permit-agent-forwarding</span>
                <span class="c1">#permit-port-forwarding</span>
                <span class="c1">#permit-pty</span>
                <span class="c1">#permit-user-rc</span>
                <span class="c1">#permit-X11-forwarding</span>


<span class="c1"># NOTE: *message[&#39;identities&#39;][0]* - An associative array conaining the key&#39;s metadata.  For example:</span>
<span class="c1">#</span>
<span class="c1">#{</span>
    <span class="c1">#&#39;name&#39;: &quot;testid&quot;,</span>
    <span class="c1">#&#39;public&#39;: &quot;ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAChqFprVjC0MKe3qpjjc+WdANOHMgcUl46dJxZ+s5soBTkO6thcJDAbFb36lg3YyzZi/PtDJV5CPp8Mv1SUXUYBqgFZJFBqWwkB0O1ohjtEVzC8+ybrY+hP0zLqykglhOi+6W66HgFwjJGn56uGE7s8UpnSRKtqGq2USyme5gopYlytTw== Generated by Gate One on somehost&quot;,</span>
    <span class="c1">#&#39;keytype&#39;: &quot;ecdsa&quot;,</span>
    <span class="c1">#&#39;bubblebabble&#39;: &quot;xevol-budez-difod-zumif-zofos-vezis-rilep-febel-tufok-lugud-dyxex&quot;,</span>
    <span class="c1">#&#39;fingerprint&#39;: &quot;0e:69:0a:9e:2e:26:2b:91:23:3d:95:4b:65:31:a9:6f&quot;,</span>
    <span class="c1">#&#39;randomart&#39;: &quot;+--[ECDSA  521]---+\n|      oo         |\n|      +.         |\n|     =           |\n|    =  .         |\n| o.o o+ S        |\n|=.oo.oEo         |\n|.oo...  .        |\n|+o               |\n|=o.              |\n+-----------------+&quot;,</span>
    <span class="c1">#&#39;certinfo&#39;: &quot;&quot;,</span>
    <span class="c1">#&#39;bits&#39;: 521,</span>
    <span class="c1">#&#39;comment&#39;: &quot;Generated by Gate One on somehost&quot;,</span>
<span class="c1">#}</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Liftoff Software Corporation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
window.onload = function(e) {
    // Make our collapseindex elements actually collapsible
    $('<span class="collapsindextitle">Index</span> <a class="showhide">[show]</a>').insertBefore('.collapseindex');
    $('.showhide').each(function(index, value){
        var showHide = $(this);
        showHide.click(function() {
            if (this.innerHTML == "[hide]") {
                this.innerHTML = "[show]";
            } else {
                this.innerHTML = "[hide]";
            }
            $(this).next('.collapseindex').toggle(1); // This should always be the next .collapseindex element
        });
    });
    $('.collapseindex').each(function(index, value){
        // Start them out hidden
        $(this).hide();
    });
}
</script>


</body>
</html>