

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29645087-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gateone.core.utils &mdash; Gate One 1.2.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/ansi.css" type="text/css" />
  

  
    <link rel="top" title="Gate One 1.2.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Gate One
          

          
          </a>

          
            
            
              <div class="version">
                1.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../About/index.html">About Gate One</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Applications/index.html">Gate One Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developer/index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ReleaseNotes/index.html">Release Notes / Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Gate One</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>gateone.core.utils</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gateone.core.utils</h1><div class="highlight"><pre>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1">#       Copyright 2013 Liftoff Software Corporation</span>
<span class="c1">#</span>
<span class="c1"># For license information see LICENSE.txt</span>

<span class="n">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.. _utils.py:</span>

<span class="s2">Gate One Utility Functions and Classes</span>
<span class="s2">======================================</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Meta</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="c1"># Import stdlib stuff</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">hmac</span><span class="o">,</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span> <span class="c1"># Python 3</span>

<span class="c1"># Import 3rd party stuff</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">locale</span>
<span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">json_encode</span> <span class="k">as</span> <span class="n">_json_encode</span>
<span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">to_unicode</span>
<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">IOLoop</span><span class="p">,</span> <span class="n">PeriodicCallback</span>

<span class="c1"># Globals</span>
<span class="n">MACOS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span>
<span class="n">OPENBSD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OpenBSD&#39;</span>
<span class="n">CSS_END</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\.css.*?$&#39;</span><span class="p">)</span>
<span class="n">JS_END</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\.js.*?$&#39;</span><span class="p">)</span>
<span class="c1"># This is used by the raw() function to show control characters</span>
<span class="n">REPLACEMENT_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s1">u&#39;^@&#39;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s1">u&#39;^A&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s1">u&#39;^B&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s1">u&#39;^C&#39;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s1">u&#39;^D&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s1">u&#39;^E&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s1">u&#39;^F&#39;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s1">u&#39;^G&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s1">u&#39;^H&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s1">u&#39;^I&#39;</span><span class="p">,</span>
    <span class="c1">#10: u&#39;^J&#39;, # Newline (\n)</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s1">u&#39;^K&#39;</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s1">u&#39;^L&#39;</span><span class="p">,</span>
    <span class="c1">#13: u&#39;^M&#39;, # Carriage return (\r)</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s1">u&#39;^N&#39;</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s1">u&#39;^O&#39;</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s1">u&#39;^P&#39;</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s1">u&#39;^Q&#39;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s1">u&#39;^R&#39;</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s1">u&#39;^S&#39;</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s1">u&#39;^T&#39;</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">:</span> <span class="s1">u&#39;^U&#39;</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s1">u&#39;^V&#39;</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s1">u&#39;^W&#39;</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s1">u&#39;^X&#39;</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">:</span> <span class="s1">u&#39;^Y&#39;</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">:</span> <span class="s1">u&#39;^Z&#39;</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">:</span> <span class="s1">u&#39;^[&#39;</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">:</span> <span class="s1">u&#39;^</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">:</span> <span class="s1">u&#39;^]&#39;</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">:</span> <span class="s1">u&#39;^^&#39;</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">:</span> <span class="s1">u&#39;^_&#39;</span><span class="p">,</span>
    <span class="mi">127</span><span class="p">:</span> <span class="s1">u&#39;^?&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">SEPARATOR</span> <span class="o">=</span> <span class="s2">u&quot;</span><span class="se">\U000f0f0f</span><span class="s2">&quot;</span> <span class="c1"># The character used to separate frames in the log</span>
<span class="c1"># Default to using the environment&#39;s locale with en_US fallback</span>
<span class="n">temp_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LANG&#39;</span><span class="p">,</span> <span class="s1">&#39;en_US&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">temp_locale</span><span class="o">.</span><span class="n">translate</span>
<span class="k">del</span> <span class="n">temp_locale</span>
<span class="c1"># The above is necessary because gateone.py won&#39;t have read in its settings</span>
<span class="c1"># until after this file has loaded.  So get_settings() won&#39;t work properly</span>
<span class="c1"># until later in the module loading process.  This lets us display translated</span>
<span class="c1"># error messages in the event that Gate One never completed loading.</span>

<span class="c1"># Exceptions</span>
<div class="viewcode-block" id="MimeTypeFail"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.MimeTypeFail">[docs]</a><span class="k">class</span> <span class="nc">MimeTypeFail</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised by `create_data_uri` if the mimetype of a file could not be guessed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="SSLGenerationError"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.SSLGenerationError">[docs]</a><span class="k">class</span> <span class="nc">SSLGenerationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised by `gen_self_signed_ssl` if an error is encountered generating a</span>
<span class="sd">    self-signed SSL certificate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ChownError"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.ChownError">[docs]</a><span class="k">class</span> <span class="nc">ChownError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised by `recursive_chown` if an OSError is encountered while trying to</span>
<span class="sd">    recursively chown a directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="AutoExpireDict"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.AutoExpireDict">[docs]</a><span class="k">class</span> <span class="nc">AutoExpireDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An override of Python&#39;s `dict` that expires keys after a given</span>
<span class="sd">    *_expire_timeout* timeout (`datetime.timedelta`).  The default expiration</span>
<span class="sd">    is one hour.  It is used like so::</span>

<span class="sd">        &gt;&gt;&gt; expiring_dict = AutoExpireDict(timeout=timedelta(minutes=10))</span>
<span class="sd">        &gt;&gt;&gt; expiring_dict[&#39;somekey&#39;] = &#39;some value&#39;</span>
<span class="sd">        &gt;&gt;&gt; # You can see when this key was created:</span>
<span class="sd">        &gt;&gt;&gt; print(expiring_dict.creation_times[&#39;somekey&#39;])</span>
<span class="sd">        2013-04-15 18:44:18.224072</span>

<span class="sd">    10 minutes later your key will be gone::</span>

<span class="sd">        &gt;&gt;&gt; &#39;somekey&#39; in expiring_dict</span>
<span class="sd">        False</span>

<span class="sd">    The &#39;timeout&#39; may be be given as a `datetime.timedelta` object or a string</span>
<span class="sd">    like, &quot;1d&quot;, &quot;30s&quot; (will be passed through the `convert_to_timedelta`</span>
<span class="sd">    function).</span>

<span class="sd">    By default `AutoExpireDict` will check for expired keys every 30 seconds but</span>
<span class="sd">    this can be changed by setting the &#39;interval&#39;::</span>

<span class="sd">        &gt;&gt;&gt; expiring_dict = AutoExpireDict(interval=5000) # 5 secs</span>
<span class="sd">        &gt;&gt;&gt; # Or to change it after you&#39;ve created one:</span>
<span class="sd">        &gt;&gt;&gt; expiring_dict.interval = &quot;10s&quot;</span>

<span class="sd">    The &#39;interval&#39; may be an integer, a `datetime.timedelta` object, or a string</span>
<span class="sd">    such as &#39;10s&#39; or &#39;5m&#39; (will be passed through the `convert_to_timedelta`</span>
<span class="sd">    function).</span>

<span class="sd">    If there are no keys remaining the `tornado.ioloop.PeriodicCallback` (</span>
<span class="sd">    ``self._key_watcher``) that checks expiration will be automatically stopped.</span>
<span class="sd">    As soon as a new key is added it will be started back up again.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Only works if there&#39;s a running instances of `tornado.ioloop.IOLoop`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation_times</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;interval&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoExpireDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Set the start time on every key</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">creation_times</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_checker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">io_loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="c1"># Will shut down at the next interval if empty</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A `property` that controls how long a key will last before being</span>
<span class="sd">        automatically removed.  May be be given as a `datetime.timedelta`</span>
<span class="sd">        object or a string like, &quot;1d&quot;, &quot;30s&quot; (will be passed through the</span>
<span class="sd">        `convert_to_timedelta` function).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_timeout&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Default is 1-hour timeout</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>

    <span class="nd">@timeout.setter</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A `property` that controls how often we check for expired keys.  May be</span>
<span class="sd">        given as milliseconds (integer), a `datetime.timedelta` object, or a</span>
<span class="sd">        string like, &quot;1d&quot;, &quot;30s&quot; (will be passed through the</span>
<span class="sd">        `convert_to_timedelta` function).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_interval&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># Default is every 10 seconds</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span>

    <span class="nd">@interval.setter</span>
    <span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">total_seconds</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c1"># PeriodicCallback uses ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interval</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Restart the PeriodicCallback</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_key_watcher&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_checker</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">io_loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="p">)</span>

<div class="viewcode-block" id="AutoExpireDict.renew"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.AutoExpireDict.renew">[docs]</a>    <span class="k">def</span> <span class="nf">renew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the timeout on the given *key*; like it was just created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation_times</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># Set/renew the start time</span>
        <span class="c1"># Start up the key watcher if it isn&#39;t already running</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An override that tracks when keys are updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoExpireDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="c1"># Set normally</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renew</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="c1"># Set/renew the start time</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An override that makes sure *key* gets removed from</span>
<span class="sd">        ``self.creation_times`` dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_times</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoExpireDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures that our `tornado.ioloop.PeriodicCallback`</span>
<span class="sd">        (``self._key_watcher``) gets stopped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<div class="viewcode-block" id="AutoExpireDict.update"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.AutoExpireDict.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An override that calls ``self.renew()`` for every key that gets updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoExpireDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renew</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoExpireDict.clear"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.AutoExpireDict.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An override that empties ``self.creation_times`` and calls</span>
<span class="sd">        ``self._key_watcher.stop()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoExpireDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation_times</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Shut down the key watcher right away</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutoExpireDict._timeout_checker"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.AutoExpireDict._timeout_checker">[docs]</a>    <span class="k">def</span> <span class="nf">_timeout_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Walks ``self`` and removes keys that have passed the expiration point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_times</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key_watcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="c1"># Nothing left to watch</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">starttime</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">creation_times</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div></div>

<span class="n">MEMO</span> <span class="o">=</span> <span class="p">{}</span>
<div class="viewcode-block" id="memoize"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.memoize">[docs]</a><span class="k">class</span> <span class="nc">memoize</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A memoization decorator that works with multiple arguments as well as</span>
<span class="sd">    unhashable arguments (e.g. dicts).  It also self-expires any memoized</span>
<span class="sd">    calls after the timedelta specified via *timeout*.</span>

<span class="sd">    If a *timeout* is not given memoized information will be discared after five</span>
<span class="sd">    minutes.</span>

<span class="sd">    .. note:: Expiration checks will be performed every 30 seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">MEMO</span> <span class="c1"># Use a global so that instances can share the cache</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MEMO</span><span class="p">:</span>
            <span class="n">MEMO</span> <span class="o">=</span> <span class="n">AutoExpireDict</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;30s&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MEMO</span><span class="p">:</span>
            <span class="c1"># Commented out because it is REALLY noisy.  Uncomment to debug</span>
            <span class="c1">#logging.debug(&quot;memoize cache miss (%s)&quot; % self.fn.__name__)</span>
            <span class="n">MEMO</span><span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#else:</span>
            <span class="c1">#logging.debug(&quot;memoize cache hit (%s)&quot; % self.fn.__name__)</span>
        <span class="k">return</span> <span class="n">MEMO</span><span class="p">[</span><span class="n">string</span><span class="p">]</span></div>

<span class="c1"># Functions</span>
<div class="viewcode-block" id="noop"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.noop">[docs]</a><span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do nothing (i.e. &quot;No Operation&quot;)&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="debug_info"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.debug_info">[docs]</a><span class="k">def</span> <span class="nf">debug_info</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns a string like this::</span>

<span class="sd">        &gt;&gt;&gt; debug_info(&#39;some_function&#39;, 5, 10, foo=&quot;bar&quot;)</span>
<span class="sd">        &#39;some_function(5, 10, foo=&quot;bar&quot;)&#39;</span>

<span class="sd">    Primarily aimed at debugging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;{0}, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;{0}={1}, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span></div>

<div class="viewcode-block" id="write_pid"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.write_pid">[docs]</a><span class="k">def</span> <span class="nf">write_pid</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes our PID to *path*.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pidfile</span><span class="p">:</span>
            <span class="c1"># Get a non-blocking exclusive lock</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">pidfile</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
            <span class="n">pidfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pidfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pidfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not write PID file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="c1"># This raises the original exception</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pidfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="read_pid"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.read_pid">[docs]</a><span class="k">def</span> <span class="nf">read_pid</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads our current PID from *path*.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span></div>

<div class="viewcode-block" id="remove_pid"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.remove_pid">[docs]</a><span class="k">def</span> <span class="nf">remove_pid</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes the PID file at *path*.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="shell_command"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.shell_command">[docs]</a><span class="k">def</span> <span class="nf">shell_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout_duration</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets the SIGCHLD signal handler (if necessary), executes *cmd* via</span>
<span class="sd">    :func:`~commands.getstatusoutput`, then re-enables the SIGCHLD handler (if</span>
<span class="sd">    it was set to something other than SIG_DFL).  Returns the result of</span>
<span class="sd">    :func:`~commands.getstatusoutput` which is a tuple in the form of::</span>

<span class="sd">        (exitstatus, output)</span>

<span class="sd">    If the command takes longer than *timeout_duration* seconds, it will be</span>
<span class="sd">    auto-killed and the following will be returned::</span>

<span class="sd">        (255, _(&quot;ERROR: Timeout running shell command&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">commands</span> <span class="kn">import</span> <span class="n">getstatusoutput</span>
    <span class="n">existing_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">)</span>
    <span class="n">default</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ERROR: Timeout running shell command&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">existing_handler</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Something other than default</span>
        <span class="c1"># Reset it to default so getstatusoutput will work properly</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># &quot;Signal only works in the main thread&quot; - no big deal.  This just</span>
            <span class="c1"># means we never needed to call signal in the first place.</span>
            <span class="k">pass</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">timeout_func</span><span class="p">(</span>
        <span class="n">getstatusoutput</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cmd</span><span class="p">,),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">timeout_duration</span><span class="o">=</span><span class="n">timeout_duration</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">existing_handler</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># Like above, signal only works from within the main thread but our use</span>
        <span class="c1"># of it here would only matter if we were in the main thread.</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="json_encode"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.json_encode">[docs]</a><span class="k">def</span> <span class="nf">json_encode</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    On some platforms (CentOS 6.2, specifically) `tornado.escape.json_decode`</span>
<span class="sd">    doesn&#39;t seem to work just right when it comes to returning unicode strings.</span>
<span class="sd">    This is just a wrapper that ensures that the returned string is unicode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">_json_encode</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="gen_self_signed_ssl"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.gen_self_signed_ssl">[docs]</a><span class="k">def</span> <span class="nf">gen_self_signed_ssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a self-signed SSL certificate using `pyOpenSSL` or the</span>
<span class="sd">    `openssl &lt;http://www.openssl.org/docs/apps/openssl.html&gt;`_ command</span>
<span class="sd">    depending on what&#39;s available,  The resulting key/certificate will use the</span>
<span class="sd">    RSA algorithm at 4096 bits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">OpenSSL</span>
        <span class="c1"># Direct OpenSSL library calls are better than executing commands...</span>
        <span class="n">gen_self_signed_func</span> <span class="o">=</span> <span class="n">gen_self_signed_pyopenssl</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">gen_self_signed_func</span> <span class="o">=</span> <span class="n">gen_self_signed_openssl</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gen_self_signed_func</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SSLGenerationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Error generating self-signed SSL key/certificate: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="gen_self_signed_openssl"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.gen_self_signed_openssl">[docs]</a><span class="k">def</span> <span class="nf">gen_self_signed_openssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method will generate a secure self-signed SSL key/certificate pair</span>
<span class="sd">    (using the `openssl &lt;http://www.openssl.org/docs/apps/openssl.html&gt;`_</span>
<span class="sd">    command) saving the result as &#39;certificate.pem&#39; and &#39;keyfile.pem&#39; to *path*.</span>
<span class="sd">    If *path* is not given the result will be saved in the current working</span>
<span class="sd">    directory.  The certificate will be valid for 10 years.</span>

<span class="sd">    .. note:: The self-signed certificate will utilize 4096-bit RSA encryption.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">keyfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;keyfile.pem&quot;</span><span class="p">)</span>
    <span class="n">certfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;certificate.pem&quot;</span><span class="p">)</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;-subj &quot;/OU=</span><span class="si">%s</span><span class="s1"> (Self-Signed)/CN=Gate One/O=Liftoff Software&quot;&#39;</span> <span class="o">%</span>
        <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Hostname</span>
    <span class="p">)</span>
    <span class="n">gen_command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;openssl genrsa -aes256 -out </span><span class="si">%s</span><span class="s2">.tmp -passout pass:password 4096&quot;</span> <span class="o">%</span>
        <span class="n">keyfile_path</span>
    <span class="p">)</span>
    <span class="n">decrypt_key_command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;openssl rsa -in {0}.tmp -passin pass:password -out {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">keyfile_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">csr_command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;openssl req -new -key </span><span class="si">%s</span><span class="s2"> -out temp.csr </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">keyfile_path</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">cert_command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;openssl x509 -req &quot;</span>    <span class="c1"># Create a new x509 certificate</span>
        <span class="s2">&quot;-days 3650 &quot;</span>           <span class="c1"># That lasts 10 years</span>
        <span class="s2">&quot;-in temp.csr &quot;</span>         <span class="c1"># Using the CSR we just generated</span>
        <span class="s2">&quot;-signkey </span><span class="si">%s</span><span class="s2"> &quot;</span>          <span class="c1"># Sign it with keyfile.pem that we just created</span>
        <span class="s2">&quot;-out </span><span class="si">%s</span><span class="s2">&quot;</span>               <span class="c1"># Save it as certificate.pem</span>
    <span class="p">)</span>
    <span class="n">cert_command</span> <span class="o">=</span> <span class="n">cert_command</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyfile_path</span><span class="p">,</span> <span class="n">certfile_path</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;Generating private key with command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gen_command</span><span class="p">))</span>
    <span class="n">exitstatus</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">gen_command</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;An error occurred trying to create private SSL key:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SSLGenerationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;Decrypting private key with command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">decrypt_key_command</span><span class="p">))</span>
    <span class="n">exitstatus</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">decrypt_key_command</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;An error occurred trying to decrypt private SSL key:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SSLGenerationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;Creating CSR with command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">csr_command</span><span class="p">))</span>
    <span class="n">exitstatus</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">csr_command</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;An error occurred trying to create CSR:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;temp.csr&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;temp.csr&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SSLGenerationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;Generating self-signed certificate with command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gen_command</span><span class="p">))</span>
    <span class="n">exitstatus</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">cert_command</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;An error occurred trying to create certificate:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;temp.csr&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;temp.csr&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">certfile_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">certfile_path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SSLGenerationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="c1"># Clean up unnecessary leftovers</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.tmp&#39;</span> <span class="o">%</span> <span class="n">keyfile_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;temp.csr&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="gen_self_signed_pyopenssl"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.gen_self_signed_pyopenssl">[docs]</a><span class="k">def</span> <span class="nf">gen_self_signed_pyopenssl</span><span class="p">(</span><span class="n">notAfter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method will generate a secure self-signed SSL key/certificate pair</span>
<span class="sd">    (using `pyOpenSSL`) saving the result as &#39;certificate.pem&#39; and &#39;keyfile.pem&#39;</span>
<span class="sd">    in *path*.  If *path* is not given the result will be saved in the current</span>
<span class="sd">    working directory.  By default the certificate will be valid for 10 years</span>
<span class="sd">    but this can be overridden by passing a valid timestamp via the</span>
<span class="sd">    *notAfter* argument.</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; gen_self_signed_ssl(60 * 60 * 24 * 365) # 1-year certificate</span>
<span class="sd">        &gt;&gt;&gt; gen_self_signed_ssl() # 10-year certificate</span>

<span class="sd">    .. note:: The self-signed certificate will utilize 4096-bit RSA encryption.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">OpenSSL</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Error: You do not have pyOpenSSL installed.  Please install &quot;</span>
            <span class="s2">&quot;it (sudo pip install pyopenssl.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SSLGenerationError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">keyfile_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/keyfile.pem&quot;</span> <span class="o">%</span> <span class="n">path</span>
    <span class="n">certfile_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/certificate.pem&quot;</span> <span class="o">%</span> <span class="n">path</span>
    <span class="n">pkey</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">PKey</span><span class="p">()</span>
    <span class="n">pkey</span><span class="o">.</span><span class="n">generate_key</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
    <span class="c1"># Save the key as &#39;keyfile.pem&#39;:</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">keyfile_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_privatekey</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">pkey</span><span class="p">))</span>
    <span class="n">cert</span> <span class="o">=</span> <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">X509</span><span class="p">()</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_serial_number</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">))</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notBefore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">notAfter</span><span class="p">:</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notAfter</span><span class="p">(</span><span class="n">notAfter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cert</span><span class="o">.</span><span class="n">gmtime_adj_notAfter</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3650</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">CN</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">get_subject</span><span class="p">()</span><span class="o">.</span><span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;Gate One Certificate&#39;</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">get_issuer</span><span class="p">()</span><span class="o">.</span><span class="n">CN</span> <span class="o">=</span> <span class="s1">&#39;Untrusted Authority&#39;</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">get_issuer</span><span class="p">()</span><span class="o">.</span><span class="n">O</span> <span class="o">=</span> <span class="s1">&#39;Self-Signed&#39;</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">set_pubkey</span><span class="p">(</span><span class="n">pkey</span><span class="p">)</span>
    <span class="n">cert</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="s1">&#39;sha512&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">certfile_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">dump_certificate</span><span class="p">(</span>
            <span class="n">OpenSSL</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert</span><span class="p">))</span></div>

<div class="viewcode-block" id="none_fix"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.none_fix">[docs]</a><span class="k">def</span> <span class="nf">none_fix</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If *val* is a string that utlimately means &#39;none&#39;, return None.  Otherwise</span>
<span class="sd">    return *val* as-is.  Examples::</span>

<span class="sd">        &gt;&gt;&gt; none_fix(&#39;none&#39;)</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; none_fix(&#39;0&#39;)</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; none_fix(&#39;whatever&#39;)</span>
<span class="sd">        &#39;whatever&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="str2bool"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.str2bool">[docs]</a><span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts strings like, &#39;false&#39;, &#39;true&#39;, &#39;0&#39;, and &#39;1&#39; into their boolean</span>
<span class="sd">    equivalents (in Python).  If no logical match is found, return False.</span>
<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; str2bool(&#39;false&#39;)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; str2bool(&#39;1&#39;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; str2bool(&#39;whatever&#39;)</span>
<span class="sd">        False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="generate_session_id"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.generate_session_id">[docs]</a><span class="k">def</span> <span class="nf">generate_session_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a random, 45-character session ID.  Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        &gt;&gt;&gt; generate_session_id()</span>
<span class="sd">        &quot;NzY4YzFmNDdhMTM1NDg3Y2FkZmZkMWJmYjYzNjBjM2Y5O&quot;</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">uuid</span>
    <span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">utf8</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span>
        <span class="n">utf8</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">))[:</span><span class="mi">45</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">bytes</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># Python 3</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session_id</span></div>

<div class="viewcode-block" id="mkdir_p"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.mkdir_p">[docs]</a><span class="k">def</span> <span class="nf">mkdir_p</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pythonic version of &quot;mkdir -p&quot;.  Example equivalents::</span>

<span class="sd">        &gt;&gt;&gt; mkdir_p(&#39;/tmp/test/testing&#39;) # Does the same thing as...</span>
<span class="sd">        &gt;&gt;&gt; from subprocess import call</span>
<span class="sd">        &gt;&gt;&gt; call(&#39;mkdir -p /tmp/test/testing&#39;)</span>

<span class="sd">    .. note:: This doesn&#39;t actually call any external commands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not create directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="c1"># The original exception</span></div>

<div class="viewcode-block" id="cmd_var_swap"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.cmd_var_swap">[docs]</a><span class="k">def</span> <span class="nf">cmd_var_swap</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns *cmd* with %variable% replaced with the keys/values passed in via</span>
<span class="sd">    *kwargs*.  This function is used by Gate One&#39;s Terminal application to</span>
<span class="sd">    swap the following Gate One variables in defined terminal &#39;commands&#39;:</span>

<span class="sd">        ==============  ==============</span>
<span class="sd">        %SESSION%       *session*</span>
<span class="sd">        %SESSION_DIR%   *session_dir*</span>
<span class="sd">        %SESSION_HASH%  *session_hash*</span>
<span class="sd">        %USERDIR%       *user_dir*</span>
<span class="sd">        %USER%          *user*</span>
<span class="sd">        %TIME%          *time*</span>
<span class="sd">        ==============  ==============</span>

<span class="sd">    This allows for unique or user-specific values to be swapped into command</span>
<span class="sd">    line arguments like so::</span>

<span class="sd">        ssh_connect.py -M -S &#39;%SESSION%/%SESSION%/%r@%L:%p&#39;</span>

<span class="sd">    Could become::</span>

<span class="sd">        ssh_connect.py -M -S &#39;/tmp/gateone/NWI0YzYxNzAwMTA3NGYyZmI0OWJmODczYmQyMjQwMDYwM/%r@%L:%p&#39;</span>

<span class="sd">    Here&#39;s an example::</span>

<span class="sd">        &gt;&gt;&gt; cmd = &quot;echo &#39;%FOO% %BAR%&#39;&quot;</span>
<span class="sd">        &gt;&gt;&gt; cmd_var_swap(cmd, foo=&quot;FOOYEAH,&quot;, bar=&quot;BAR NONE!&quot;)</span>
<span class="sd">        &quot;echo &#39;FOOYEAH, BAR NONE!&#39;&quot;</span>

<span class="sd">    .. note::</span>

<span class="sd">        The variables passed into this function via *kwargs* are case</span>
<span class="sd">        insensitive.  `cmd_var_swap(cmd, session=var)` would produce the same</span>
<span class="sd">        output as `cmd_var_swap(cmd, SESSION=var)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="c1"># Force to string in case of things like integers</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">u&#39;%{key}%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmd</span></div>

<div class="viewcode-block" id="short_hash"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.short_hash">[docs]</a><span class="k">def</span> <span class="nf">short_hash</span><span class="p">(</span><span class="n">to_shorten</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts *to_shorten* into a really short hash depenendent on the length of</span>
<span class="sd">    *to_shorten*.  The result will be safe for use as a file name.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Collisions are possible but *highly* unlikely because of how this method</span>
<span class="sd">        is typically used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">to_shorten</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="c1"># Take the first eight characters to create a shortened version.</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">hashed</span><span class="o">.</span><span class="n">digest</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hashed</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
        <span class="n">hashed</span> <span class="o">=</span> <span class="n">hashed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashed</span></div>

<div class="viewcode-block" id="random_words"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.random_words">[docs]</a><span class="k">def</span> <span class="nf">random_words</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns *n* random English words (as a tuple of strings) from the</span>
<span class="sd">    `english_wordlist.txt` file (bundled with Gate One).</span>

<span class="sd">    .. note:: In Python 2 the words will be Unicode strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_string</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">resource_string</span><span class="p">(</span>
        <span class="s1">&#39;gateone&#39;</span><span class="p">,</span> <span class="s1">&#39;static/english_wordlist.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">out_words</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">))]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">out_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out_words</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_process_tree"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.get_process_tree">[docs]</a><span class="k">def</span> <span class="nf">get_process_tree</span><span class="p">(</span><span class="n">parent_pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of child pids that were spawned from *parent_pid*.</span>

<span class="sd">    .. note:: Will include parent_pid in the output list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parent_pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_pid</span><span class="p">)</span> <span class="c1"># Has to be a string</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">)</span>
    <span class="n">retcode</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> -ef&#39;</span> <span class="o">%</span> <span class="n">ps</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent_pid</span><span class="p">]</span>
    <span class="n">pidmap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Construct the pidmap:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">split_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">split_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ppid</span> <span class="o">=</span> <span class="n">split_line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pidmap</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pid</span><span class="p">,</span> <span class="n">ppid</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">walk_pids</span><span class="p">(</span><span class="n">pidmap</span><span class="p">,</span> <span class="n">checkpid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively walks the given *pidmap* and updates the *out* variable with</span>
<span class="sd">        the child pids of *checkpid*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ppid</span> <span class="ow">in</span> <span class="n">pidmap</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ppid</span> <span class="o">==</span> <span class="n">checkpid</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="n">walk_pids</span><span class="p">(</span><span class="n">pidmap</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">walk_pids</span><span class="p">(</span><span class="n">pidmap</span><span class="p">,</span> <span class="n">parent_pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="kill_dtached_proc"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.kill_dtached_proc">[docs]</a><span class="k">def</span> <span class="nf">kill_dtached_proc</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kills the dtach processes associated with the given *session* that matches</span>
<span class="sd">    the given *location* and *term*.  All the dtach&#39;d sub-processes will be</span>
<span class="sd">    killed as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;kill_dtached_proc(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">term</span><span class="p">))</span>
    <span class="n">dtach_socket_name</span> <span class="o">=</span> <span class="s1">&#39;dtach_{location}_{term}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">)</span>
    <span class="n">to_kill</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;/proc&#39;</span><span class="p">):</span>
        <span class="n">pid_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/proc&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pid_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c1"># Not a PID</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pid_dir</span><span class="p">,</span> <span class="s1">&#39;cmdline&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cmdline</span> <span class="ow">and</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">cmdline</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dtach_socket_name</span> <span class="ow">in</span> <span class="n">cmdline</span><span class="p">:</span>
                        <span class="n">to_kill</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># Already dead, no big deal.</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">to_kill</span><span class="p">:</span>
        <span class="n">kill_pids</span> <span class="o">=</span> <span class="n">get_process_tree</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_pid</span> <span class="ow">in</span> <span class="n">kill_pids</span><span class="p">:</span>
            <span class="n">_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_pid</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">_pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># Process already died.  Not a problem.</span></div>

<div class="viewcode-block" id="kill_dtached_proc_bsd"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.kill_dtached_proc_bsd">[docs]</a><span class="k">def</span> <span class="nf">kill_dtached_proc_bsd</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A BSD-specific implementation of `kill_dtached_proc` since Macs don&#39;t have</span>
<span class="sd">    /proc.  Seems simpler than :func:`kill_dtached_proc` but actually having to</span>
<span class="sd">    call a subprocess is less efficient (due to the sophisticated signal</span>
<span class="sd">    handling required by :func:`shell_command`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;kill_dtached_proc_bsd(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">term</span><span class="p">))</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MACOS</span><span class="p">:</span>
        <span class="n">psopts</span> <span class="o">=</span> <span class="s2">&quot;-ef&quot;</span>
    <span class="k">elif</span> <span class="n">OPENBSD</span><span class="p">:</span>
        <span class="n">psopts</span> <span class="o">=</span> <span class="s2">&quot;-aux&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> | &quot;</span>
        <span class="s2">&quot;grep </span><span class="si">%s</span><span class="s2">/dtach_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2"> | &quot;</span> <span class="c1"># Match our exact session/location/term combo</span>
        <span class="s2">&quot;grep -v grep | &quot;</span> <span class="c1"># Get rid of grep from the results (if present)</span>
        <span class="s2">&quot;awk &#39;{print $2}&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">psopts</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="c1"># Just PID</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;kill cmd: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">exitstatus</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">pid_to_kill</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># Get rid of trailing newline</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">get_process_tree</span><span class="p">(</span><span class="n">pid_to_kill</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># Process already died.  Not a problem.</span></div>

<div class="viewcode-block" id="killall"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.killall">[docs]</a><span class="k">def</span> <span class="nf">killall</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kills all running Gate One terminal processes including any detached dtach</span>
<span class="sd">    sessions.</span>

<span class="sd">    :session_dir: The path to Gate One&#39;s session directory.</span>
<span class="sd">    :pid_file: The path to Gate One&#39;s PID file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_dir</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No lieutenant, your processes are already dead.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="c1"># Nothing to do</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Killing all Gate One processes...&quot;</span><span class="p">))</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">session_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;/proc&#39;</span><span class="p">):</span>
        <span class="n">pid_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/proc&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pid_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">():</span>
                    <span class="k">continue</span> <span class="c1"># It would be suicide!</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c1"># Not a PID</span>
            <span class="n">cmdline_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pid_dir</span><span class="p">,</span> <span class="s1">&#39;cmdline&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmdline_path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cmdline_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">cmdline</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="c1"># Can happen if a process ended as we were looking at it</span>
                    <span class="k">continue</span>
            <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">cmdline</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">pass</span> <span class="c1"># PID is already dead--great</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">go_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s2">&quot;Could not open pid_file (</span><span class="si">%s</span><span class="s2">).  You *may* have to kill gateone.py &quot;</span>
            <span class="s2">&quot;manually (probably not).&quot;</span> <span class="o">%</span> <span class="n">pid_file</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">go_pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c1"># PID is already dead--great</span></div>

<div class="viewcode-block" id="killall_bsd"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.killall_bsd">[docs]</a><span class="k">def</span> <span class="nf">killall_bsd</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">pid_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A BSD-specific version of `killall` since Macs don&#39;t have /proc.</span>

<span class="sd">    .. note::</span>

<span class="sd">        *pid_file* is not used by this function.  It is simply here to provide</span>
<span class="sd">        compatibility with `killall`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: See if there&#39;s a better way to keep track of subprocesses so we</span>
    <span class="c1"># don&#39;t have to enumerate the process table at all.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;killall_bsd(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">session_dir</span><span class="p">)</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">session_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MACOS</span><span class="p">:</span>
        <span class="n">psopts</span> <span class="o">=</span> <span class="s2">&quot;-ef&quot;</span>
    <span class="k">elif</span> <span class="n">OPENBSD</span><span class="p">:</span>
        <span class="n">psopts</span> <span class="o">=</span> <span class="s2">&quot;-aux&quot;</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ps </span><span class="si">%s</span><span class="s2"> | &quot;</span>
            <span class="s2">&quot;grep </span><span class="si">%s</span><span class="s2"> | &quot;</span> <span class="c1"># Limit to those matching the session</span>
            <span class="s2">&quot;grep -v grep | &quot;</span> <span class="c1"># Get rid of grep from the results (if present)</span>
            <span class="s2">&quot;awk &#39;{print $2}&#39; | &quot;</span> <span class="c1"># Just the PID please</span>
            <span class="s2">&quot;xargs kill&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">psopts</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="c1"># Kill em&#39;</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;killall cmd: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">exitstatus</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="kill_session_processes"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.kill_session_processes">[docs]</a><span class="k">def</span> <span class="nf">kill_session_processes</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kills all processes that match a given *session* (which is a unique,</span>
<span class="sd">    45-character string).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">psopts</span> <span class="o">=</span> <span class="s2">&quot;aux&quot;</span>
    <span class="k">if</span> <span class="n">MACOS</span><span class="p">:</span>
        <span class="n">psopts</span> <span class="o">=</span> <span class="s2">&quot;-ef&quot;</span>
    <span class="k">elif</span> <span class="n">OPENBSD</span><span class="p">:</span>
        <span class="n">psopts</span> <span class="o">=</span> <span class="s2">&quot;-aux&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;ps </span><span class="si">%s</span><span class="s2"> | &quot;</span>
        <span class="s2">&quot;grep </span><span class="si">%s</span><span class="s2"> | &quot;</span> <span class="c1"># Limit to those matching the session</span>
        <span class="s2">&quot;grep -v grep | &quot;</span> <span class="c1"># Get rid of grep from the results (if present)</span>
        <span class="s2">&quot;awk &#39;{print $2}&#39; | &quot;</span> <span class="c1"># Just the PID please</span>
        <span class="s2">&quot;xargs kill&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">psopts</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="c1"># Kill em&#39;</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;kill_session_processes cmd: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">exitstatus</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="entry_point_files"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.entry_point_files">[docs]</a><span class="k">def</span> <span class="nf">entry_point_files</span><span class="p">(</span><span class="n">ep_group</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an entry point group name (*ep_group*), returns a dict of available</span>
<span class="sd">    Python, JS, and CSS plugins for Gate One::</span>

<span class="sd">        {</span>
<span class="sd">            &#39;css&#39;: [&#39;editor/static/codemirror.css&#39;],</span>
<span class="sd">            &#39;js&#39;: [&#39;editor/static/codemirror.js&#39;, &#39;editor/static/editor.js&#39;],</span>
<span class="sd">            &#39;py&#39;: [&lt;module &#39;gateone.plugins.editor&#39; from &#39;gateone/plugins/editor/__init__.pyc&#39;&gt;]</span>
<span class="sd">        }</span>

<span class="sd">    Optionally, the returned dict will include only those modules and files for</span>
<span class="sd">    plugins in the *enabled* list (if given).</span>

<span class="sd">    .. note::</span>

<span class="sd">        Python plugins will be imported automatically as part of the</span>
<span class="sd">        discovery process.</span>

<span class="sd">    To do this it uses the `pkg_resources` module from setuptools.  For plugins</span>
<span class="sd">    to be imported correctly they need to register themselves using the given</span>
<span class="sd">    `entry_point` group (*ep_group*) in their setup.py.  Gate One (currently)</span>
<span class="sd">    uses the following entry point group names:</span>

<span class="sd">        * go_plugins</span>
<span class="sd">        * go_applications</span>
<span class="sd">        * go_applications_plugins</span>

<span class="sd">    ...but this function can return the JS, CSS, and Python modules for any</span>
<span class="sd">    entry point that uses the same module_name/static/ layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pkg_resources</span><span class="o">,</span> <span class="nn">operator</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span><span class="p">:</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ep_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;py&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;js&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;css&#39;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">iter_entry_points</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">ep_group</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="n">plugin</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabled</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># Not enabled, skip it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Could not import entry point module: {0}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">ep_dict</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">][</span><span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
        <span class="n">static_path</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/static/&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pkg_files</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_listdir</span><span class="p">(</span>
                <span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="s1">&#39;/static/&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ep_dict</span><span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">][</span><span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ep_dict</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">][</span><span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">pkg_files</span><span class="p">:</span>
            <span class="n">f_path</span> <span class="o">=</span> <span class="s2">&quot;/static/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.js&#39;</span><span class="p">):</span>
                <span class="n">ep_dict</span><span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">][</span><span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.css&#39;</span><span class="p">):</span>
                <span class="n">ep_dict</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">][</span><span class="n">plugin</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ep_dict</span></div>

<div class="viewcode-block" id="load_modules"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.load_modules">[docs]</a><span class="k">def</span> <span class="nf">load_modules</span><span class="p">(</span><span class="n">modules</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of Python *modules*, imports them.</span>

<span class="sd">    .. note::  Assumes they&#39;re all in `sys.path`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;load_modules(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">modules</span><span class="p">)</span>
    <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
        <span class="n">imported</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imported</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_list</span></div>

<div class="viewcode-block" id="merge_handlers"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.merge_handlers">[docs]</a><span class="k">def</span> <span class="nf">merge_handlers</span><span class="p">(</span><span class="n">handlers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a list of Tornado *handlers* like this::</span>

<span class="sd">        [</span>
<span class="sd">            (r&quot;/&quot;, MainHandler),</span>
<span class="sd">            (r&quot;/ws&quot;, TerminalWebSocket),</span>
<span class="sd">            (r&quot;/auth&quot;, AuthHandler),</span>
<span class="sd">            (r&quot;/style&quot;, StyleHandler),</span>
<span class="sd">                ...</span>
<span class="sd">            (r&quot;/style&quot;, SomePluginHandler),</span>
<span class="sd">        ]</span>

<span class="sd">    ...and returns a list with duplicate handlers removed; giving precedence to</span>
<span class="sd">    handlers with higher indexes.  This allows plugins to override Gate One&#39;s</span>
<span class="sd">    default handlers.  Given the above, this is what would be returned::</span>

<span class="sd">        [</span>
<span class="sd">            (r&quot;/&quot;, MainHandler),</span>
<span class="sd">            (r&quot;/ws&quot;, TerminalWebSocket),</span>
<span class="sd">            (r&quot;/auth&quot;, AuthHandler),</span>
<span class="sd">                ...</span>
<span class="sd">            (r&quot;/style&quot;, SomePluginHandler),</span>
<span class="sd">        ]</span>

<span class="sd">    This example would replace the default &quot;/style&quot; handler with</span>
<span class="sd">    SomePluginHandler; overriding Gate One&#39;s default StyleHandler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">regexes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">handlers</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">regexes</span><span class="p">:</span>
            <span class="n">regexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">out_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out_list</span></div>

<span class="c1"># NOTE: This function has been released under the Apache 2.0 license.</span>
<span class="c1"># See: http://code.activestate.com/recipes/577894-convert-strings-like-5d-and-60s-to-timedelta-objec/</span>
<div class="viewcode-block" id="convert_to_timedelta"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.convert_to_timedelta">[docs]</a><span class="k">def</span> <span class="nf">convert_to_timedelta</span><span class="p">(</span><span class="n">time_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a *time_val* (string) such as &#39;5d&#39;, returns a `datetime.timedelta`</span>
<span class="sd">    object representing the given value (e.g. `timedelta(days=5)`).  Accepts the</span>
<span class="sd">    following &#39;&lt;num&gt;&lt;char&gt;&#39; formats:</span>

<span class="sd">    =========   ============ =========================</span>
<span class="sd">    Character   Meaning      Example</span>
<span class="sd">    =========   ============ =========================</span>
<span class="sd">    (none)      Milliseconds &#39;500&#39; -&gt; 500 Milliseconds</span>
<span class="sd">    s           Seconds      &#39;60s&#39; -&gt; 60 Seconds</span>
<span class="sd">    m           Minutes      &#39;5m&#39;  -&gt; 5 Minutes</span>
<span class="sd">    h           Hours        &#39;24h&#39; -&gt; 24 Hours</span>
<span class="sd">    d           Days         &#39;7d&#39;  -&gt; 7 Days</span>
<span class="sd">    M           Months       &#39;2M&#39;  -&gt; 2 Months</span>
<span class="sd">    y           Years        &#39;10y&#39; -&gt; 10 Years</span>
<span class="sd">    =========   ============ =========================</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; convert_to_timedelta(&#39;7d&#39;)</span>
<span class="sd">        datetime.timedelta(7)</span>
<span class="sd">        &gt;&gt;&gt; convert_to_timedelta(&#39;24h&#39;)</span>
<span class="sd">        datetime.timedelta(1)</span>
<span class="sd">        &gt;&gt;&gt; convert_to_timedelta(&#39;60m&#39;)</span>
<span class="sd">        datetime.timedelta(0, 3600)</span>
<span class="sd">        &gt;&gt;&gt; convert_to_timedelta(&#39;120s&#39;)</span>
<span class="sd">        datetime.timedelta(0, 120)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_val</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">time_val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">time_val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="o">*</span><span class="mi">30</span><span class="p">))</span>  <span class="c1"># Yeah this is approximate</span>
    <span class="k">elif</span> <span class="n">time_val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="o">*</span><span class="mi">365</span><span class="p">))</span> <span class="c1"># Sorry, no leap year support</span></div>

<div class="viewcode-block" id="convert_to_bytes"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.convert_to_bytes">[docs]</a><span class="k">def</span> <span class="nf">convert_to_bytes</span><span class="p">(</span><span class="n">size_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a *size_val* (string) such as &#39;100M&#39;, returns an integer representing</span>
<span class="sd">    an equivalent amount of bytes.  Accepts the following &#39;&lt;num&gt;&lt;char&gt;&#39; formats:</span>

<span class="sd">    =========== ==========  ==================================</span>
<span class="sd">    Character   Meaning     Example</span>
<span class="sd">    =========== ==========  ==================================</span>
<span class="sd">    B (or none) Bytes       &#39;100&#39; or &#39;100b&#39; -&gt; 100</span>
<span class="sd">    K           Kilobytes   &#39;1k&#39; -&gt; 1024</span>
<span class="sd">    M           Megabytes   &#39;1m&#39; -&gt; 1048576</span>
<span class="sd">    G           Gigabytes   &#39;1g&#39; -&gt; 1073741824</span>
<span class="sd">    T           Terabytes   &#39;1t&#39; -&gt; 1099511627776</span>
<span class="sd">    P           Petabytes   &#39;1p&#39; -&gt; 1125899906842624</span>
<span class="sd">    E           Exabytes    &#39;1e&#39; -&gt; 1152921504606846976</span>
<span class="sd">    Z           Zettabytes  &#39;1z&#39; -&gt; 1180591620717411303424L</span>
<span class="sd">    Y           Yottabytes  &#39;7y&#39; -&gt; 1208925819614629174706176L</span>
<span class="sd">    =========== ==========  ==================================</span>

<span class="sd">    .. note::</span>

<span class="sd">        If no character is given the *size_val* will be assumed to be in bytes.</span>

<span class="sd">    .. tip::</span>

<span class="sd">        All characters will be converted to upper case before conversion</span>
<span class="sd">        (case-insensitive).</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; convert_to_bytes(&#39;2M&#39;)</span>
<span class="sd">        2097152</span>
<span class="sd">        &gt;&gt;&gt; convert_to_bytes(&#39;2g&#39;)</span>
<span class="sd">        2147483648</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="s2">&quot;BKMGTPEZY&quot;</span>
    <span class="n">letter</span> <span class="o">=</span> <span class="n">size_val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">letter</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span> <span class="c1"># Assume bytes</span>
        <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">size_val</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">size_val</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">num</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">symbols</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="mi">1</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">size_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">symbols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">prefix</span><span class="p">[</span><span class="n">size_val</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">prefix</span><span class="p">[</span><span class="n">letter</span><span class="p">])</span></div>

<div class="viewcode-block" id="total_seconds"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.total_seconds">[docs]</a><span class="k">def</span> <span class="nf">total_seconds</span><span class="p">(</span><span class="n">td</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a timedelta (*td*) return an integer representing the equivalent of</span>
<span class="sd">    Python 2.7&#39;s :meth:`datetime.timdelta.total_seconds`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(((</span>
        <span class="n">td</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">td</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span></div>

<div class="viewcode-block" id="process_opt_esc_sequence"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.process_opt_esc_sequence">[docs]</a><span class="k">def</span> <span class="nf">process_opt_esc_sequence</span><span class="p">(</span><span class="n">chars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the *chars* passed from :class:`terminal.Terminal` by way of the</span>
<span class="sd">    special, optional escape sequence handler (e.g. &#39;&lt;plugin&gt;|&lt;text&gt;&#39;) into a</span>
<span class="sd">    tuple of (&lt;plugin name&gt;, &lt;text&gt;).  Here&#39;s an example::</span>

<span class="sd">        &gt;&gt;&gt; process_opt_esc_sequence(&#39;ssh|user@host:22&#39;)</span>
<span class="sd">        (&#39;ssh&#39;, &#39;user@host:22&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plugin</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plugin</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">chars</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c1"># Something went horribly wrong!</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="raw"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.raw">[docs]</a><span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">replacement_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns *text* as a string with special characters replaced by visible</span>
<span class="sd">    equivalents using *replacement_dict*.  If *replacement_dict* is None or</span>
<span class="sd">    False the global REPLACEMENT_DICT will be used.  Example::</span>

<span class="sd">        &gt;&gt;&gt; test = &#39;\\x1b]0;Some xterm title\\x07&#39;</span>
<span class="sd">        &gt;&gt;&gt; print(raw(test))</span>
<span class="sd">        &#39;^[]0;Some title^G&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">replacement_dict</span><span class="p">:</span>
        <span class="n">replacement_dict</span> <span class="o">=</span> <span class="n">REPLACEMENT_DICT</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">charnum</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charnum</span> <span class="ow">in</span> <span class="n">replacement_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">replacement_dict</span><span class="p">[</span><span class="n">charnum</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">char</span>
    <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="create_data_uri"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.create_data_uri">[docs]</a><span class="k">def</span> <span class="nf">create_data_uri</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a file at *filepath*, return that file as a data URI.</span>

<span class="sd">    Raises a `MimeTypeFail` exception if the mimetype could not be guessed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mimetype</span><span class="p">:</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mimetype</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MimeTypeFail</span><span class="p">(</span><span class="s2">&quot;Could not guess mime type of: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65000</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;WARNING: Data URI &gt; 65,000 characters.  You&#39;re pushing it buddy!&quot;</span><span class="p">)</span>
    <span class="n">data_uri</span> <span class="o">=</span> <span class="s2">&quot;data:</span><span class="si">%s</span><span class="s2">;base64,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mimetype</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_uri</span></div>

<div class="viewcode-block" id="human_readable_bytes"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.human_readable_bytes">[docs]</a><span class="k">def</span> <span class="nf">human_readable_bytes</span><span class="p">(</span><span class="n">nbytes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns *nbytes* as a human-readable string in a similar fashion to how it</span>
<span class="sd">    would be displayed by `ls -lh` or `df -h`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span>
    <span class="k">if</span> <span class="n">nbytes</span> <span class="o">&gt;=</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">T&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nbytes</span><span class="p">)</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">nbytes</span> <span class="o">&gt;=</span> <span class="n">G</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">G&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nbytes</span><span class="p">)</span><span class="o">/</span><span class="n">G</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">nbytes</span> <span class="o">&gt;=</span> <span class="n">M</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">M&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nbytes</span><span class="p">)</span><span class="o">/</span><span class="n">M</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">nbytes</span> <span class="o">&gt;=</span> <span class="n">K</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">K&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nbytes</span><span class="p">)</span><span class="o">/</span><span class="n">K</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nbytes</span></div>

<div class="viewcode-block" id="which"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.which">[docs]</a><span class="k">def</span> <span class="nf">which</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the full path of *binary* (string) just like the &#39;which&#39; command.</span>
<span class="sd">    Optionally, a *path* (colon-delimited string) may be given to use instead of</span>
<span class="sd">    `os.environ[&#39;PATH&#39;]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binary</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">binary</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="touch"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.touch">[docs]</a><span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Emulates the &#39;touch&#39; command by creating the file at *path* if it does not</span>
<span class="sd">    exist.  If the file exist its modification time will be updated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="timeout_func"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.timeout_func">[docs]</a><span class="k">def</span> <span class="nf">timeout_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">timeout_duration</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets a timeout on the given function, passing it the given args, kwargs,</span>
<span class="sd">    and a *default* value to return in the event of a timeout.  If *default* is</span>
<span class="sd">    a function that function will be called in the event of a timeout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">threading</span>
    <span class="k">class</span> <span class="nc">InterruptableThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">default</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">InterruptableThread</span><span class="p">()</span>
    <span class="n">it</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">it</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout_duration</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">it</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">default</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">result</span></div>

<div class="viewcode-block" id="valid_hostname"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.valid_hostname">[docs]</a><span class="k">def</span> <span class="nf">valid_hostname</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">allow_underscore</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns True if the given *hostname* is valid according to RFC rules.  Works</span>
<span class="sd">    with Internationalized Domain Names (IDN) and optionally, hostnames with an</span>
<span class="sd">    underscore (if *allow_underscore* is True).</span>

<span class="sd">    The rules for hostnames:</span>

<span class="sd">        * Must be less than 255 characters.</span>
<span class="sd">        * Individual labels (separated by dots) must be &lt;= 63 characters.</span>
<span class="sd">        * Only the ASCII alphabet (A-Z) is allowed along with dashes (-) and dots (.).</span>
<span class="sd">        * May not start with a dash or a dot.</span>
<span class="sd">        * May not end with a dash.</span>
<span class="sd">        * If an IDN, when converted to Punycode it must comply with the above.</span>

<span class="sd">    IP addresses will be validated according to their well-known specifications.</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; valid_hostname(&#39;foo.bar.com.&#39;) # Standard FQDN</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; valid_hostname(&#39;2foo&#39;) # Short hostname</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; valid_hostname(&#39;-2foo&#39;) # No good:  Starts with a dash</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; valid_hostname(&#39;host_a&#39;) # No good: Can&#39;t have underscore</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; valid_hostname(&#39;host_a&#39;, allow_underscore=True) # Now it&#39;ll validate</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; valid_hostname(u&#39;ジェーピーニック.jp&#39;) # Example valid IDN</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to Punycode if an IDN</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;idna&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span> <span class="c1"># Can&#39;t convert to Punycode: Bad hostname</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">hostname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">b</span><span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="c1"># Strip the tailing dot if present</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">b</span><span class="s2">&quot;(?!-)[A-Z\d-]{1,63}(?&lt;!-)$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allow_underscore</span><span class="p">:</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">b</span><span class="s2">&quot;(?!-)[_A-Z\d-]{1,63}(?&lt;!-)$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">allowed</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hostname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s2">&quot;.&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="recursive_chown"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.recursive_chown">[docs]</a><span class="k">def</span> <span class="nf">recursive_chown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Emulates &#39;chown -R *uid*:*gid* *path*&#39; in pure Python&quot;&quot;&quot;</span>
    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
        <span class="s2">&quot;Error: Gate One does not have the ability to recursively chown </span><span class="si">%s</span><span class="s2"> to &quot;</span>
        <span class="s2">&quot;uid </span><span class="si">%s</span><span class="s2">/gid </span><span class="si">%s</span><span class="s2">.  Please ensure that user, </span><span class="si">%s</span><span class="s2"> has write permission to &quot;</span>
        <span class="s2">&quot;the directory.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pwd</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ChownError</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">momo</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="n">_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">momo</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pwd</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">ChownError</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">for</span> <span class="n">momo</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">momo</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pwd</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">ChownError</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span></div>

<div class="viewcode-block" id="check_write_permissions"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.check_write_permissions">[docs]</a><span class="k">def</span> <span class="nf">check_write_permissions</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns `True` if the given *user* has write permissions to *path*.  *user*</span>
<span class="sd">    can be a UID (int) or a username (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pwd</span><span class="o">,</span> <span class="nn">grp</span><span class="o">,</span> <span class="nn">stat</span>
    <span class="c1"># Get the user&#39;s complete passwd record</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="c1"># Assume root can write to everything (NFS notwithstanding)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># A combination of user&#39;s primary GID and supplemental groups</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrall</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_name</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">gr_mem</span><span class="p">:</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">gr_gid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">gr_gid</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">:</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">gr_gid</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">other_write</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWOTH</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">other_write</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="c1"># Read/write world!</span>
    <span class="n">owner_write</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">st_uid</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_uid</span> <span class="ow">and</span> <span class="n">owner_write</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="c1"># User can write to their own file</span>
    <span class="n">group_write</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWGRP</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">st_gid</span> <span class="ow">in</span> <span class="n">groups</span> <span class="ow">and</span> <span class="n">group_write</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="c1"># User belongs to a group that can write to the file</span>
    <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="bind"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.bind">[docs]</a><span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will return *function* with *self* bound as the first argument.  Allows one</span>
<span class="sd">    to write functions like this::</span>

<span class="sd">        def foo(self, whatever):</span>
<span class="sd">            return whatever</span>

<span class="sd">    ...outside of the construct of a class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="minify"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.minify">[docs]</a><span class="k">def</span> <span class="nf">minify</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns *path_or_fileobj* as a minified string.  *kind* should be one of</span>
<span class="sd">    &#39;js&#39; or &#39;css&#39;.  Works with JavaScript and CSS files using `slimit` and</span>
<span class="sd">    `cssmin`, respectively.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">slimit</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">slimit</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">cssmin</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">cssmin</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">if</span> <span class="n">slimit</span> <span class="ow">and</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;js&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">slimit</span><span class="o">.</span><span class="n">minify</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mangle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;(saved ~</span><span class="si">%s</span><span class="s2"> bytes minifying </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;slimit failed trying to minify </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cssmin</span> <span class="ow">and</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;css&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">cssmin</span><span class="o">.</span><span class="n">cssmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;(saved ~</span><span class="si">%s</span><span class="s2"> bytes minifying </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span></div>

<span class="c1"># This is so we can have the argument below be &#39;minify&#39; (user friendly)</span>
<span class="n">_minify</span> <span class="o">=</span> <span class="n">minify</span>

<div class="viewcode-block" id="get_or_cache"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.get_or_cache">[docs]</a><span class="k">def</span> <span class="nf">get_or_cache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">minify</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a *path*, returns the cached version of that file.  If the file has</span>
<span class="sd">    yet to be cached, cache it and return the result.  If *minify* is `True`</span>
<span class="sd">    (the default), the file will be minified as part of the caching process (if</span>
<span class="sd">    possible).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Need to store the original file&#39;s modification time in the filename</span>
    <span class="c1"># so we can tell if the original changed in the event that Gate One is</span>
    <span class="c1"># restarted.</span>
    <span class="c1"># Also, we&#39;re using the full path in the cached filename in the event</span>
    <span class="c1"># that two files have the same name but at different paths.</span>
    <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
    <span class="n">shortened_path</span> <span class="o">=</span> <span class="n">short_hash</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">cached_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shortened_path</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span>
    <span class="n">cached_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">cached_filename</span><span class="p">)</span>
    <span class="c1"># Check if the file has changed since last time and use the cached</span>
    <span class="c1"># version if it makes sense to do so.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cached_file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cached_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">minify</span><span class="p">:</span>
        <span class="c1"># Using regular expressions here because rendered filenames often end</span>
        <span class="c1"># like this: .css_1357311277</span>
        <span class="c1"># Hopefully this is a good enough classifier.</span>
        <span class="k">if</span> <span class="n">JS_END</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;js&#39;</span>
        <span class="k">elif</span> <span class="n">CSS_END</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;css&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Just cache it as-is; no minification</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">kind</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_minify</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
            <span class="c1"># Cache it</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cached_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1"># Clean up old versions of this file (if present)</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="n">cached_filename</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">shortened_path</span><span class="p">):</span>
            <span class="c1"># Older version present.  Remove it.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="drop_privileges"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.drop_privileges">[docs]</a><span class="k">def</span> <span class="nf">drop_privileges</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="s1">&#39;nobody&#39;</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="s1">&#39;nogroup&#39;</span><span class="p">,</span> <span class="n">supl_groups</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop privileges by changing the current process owner/group to</span>
<span class="sd">    *uid*/*gid* (both may be an integer or a string).  If *supl_groups* (list)</span>
<span class="sd">    is given the process will be assigned those values as its effective</span>
<span class="sd">    supplemental groups.  If *supl_groups* is None it will default to using</span>
<span class="sd">    &#39;tty&#39; as the only supplemental group.  Example::</span>

<span class="sd">        drop_privileges(&#39;gateone&#39;, &#39;gateone&#39;, [&#39;tty&#39;])</span>

<span class="sd">    This would change the current process owner to gateone/gateone with &#39;tty&#39; as</span>
<span class="sd">    its only supplemental group.</span>

<span class="sd">    .. note::</span>

<span class="sd">        On most Unix systems users must belong to the &#39;tty&#39; group to create new</span>
<span class="sd">        controlling TTYs which is necessary for &#39;pty.fork()&#39; to work.</span>

<span class="sd">    .. tip::</span>

<span class="sd">        If you get errors like, &quot;OSError: out of pty devices&quot; it likely means</span>
<span class="sd">        that your OS uses something other than &#39;tty&#39; as the group owner of the</span>
<span class="sd">        devpts filesystem.  &#39;mount | grep pts&#39; will tell you the owner (look for</span>
<span class="sd">        gid=&lt;owner&gt;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pwd</span><span class="o">,</span> <span class="nn">grp</span>
    <span class="n">human_supl_groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">running_uid</span> <span class="o">=</span> <span class="n">uid</span>
    <span class="n">running_gid</span> <span class="o">=</span> <span class="n">gid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Get the uid/gid from the name</span>
        <span class="n">running_uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">running_gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
    <span class="k">if</span> <span class="n">supl_groups</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">supl_groups</span><span class="p">)):</span>
            <span class="c1"># Just update in-place</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">supl_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
            <span class="n">human_supl_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">supl_groups</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">gr_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">setgroups</span><span class="p">(</span><span class="n">supl_groups</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Could not set supplemental groups: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
            <span class="nb">exit</span><span class="p">()</span>
    <span class="c1"># Try setting the new uid/gid</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">running_gid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Could not set effective group id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
        <span class="nb">exit</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">running_uid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Could not set effective user id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
        <span class="nb">exit</span><span class="p">()</span>
    <span class="c1"># Ensure a very convervative umask</span>
    <span class="n">new_umask</span> <span class="o">=</span> <span class="mi">0</span><span class="n">o77</span>
    <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">new_umask</span><span class="p">)</span>
    <span class="c1"># Fix some basic/known environment variables</span>
    <span class="n">pwd_obj</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">running_uid</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwd_obj</span><span class="o">.</span><span class="n">pw_name</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LOGNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwd_obj</span><span class="o">.</span><span class="n">pw_name</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwd_obj</span><span class="o">.</span><span class="n">pw_dir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SHELL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwd_obj</span><span class="o">.</span><span class="n">pw_shell</span>
    <span class="n">final_gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s1">&#39;Running as user/group, &quot;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&quot; with the following supplemental groups:&#39;</span>
        <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pwd_obj</span><span class="o">.</span><span class="n">pw_name</span><span class="p">,</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">final_gid</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">human_supl_groups</span><span class="p">))</span>
    <span class="p">))</span></div>

<div class="viewcode-block" id="strip_xss"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.strip_xss">[docs]</a><span class="k">def</span> <span class="nf">strip_xss</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">whitelist</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="s2">u&quot;</span><span class="se">\u2421</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns a tuple containing:</span>

<span class="sd">        * *html* with all non-whitelisted HTML tags replaced with *replacement*.  Any tags that contain JavaScript, VBScript, or other known XSS/executable functions will also be removed.</span>
<span class="sd">        * A list containing the tags that were removed.</span>

<span class="sd">    If *whitelist* is not given the following will be used::</span>

<span class="sd">        whitelist = set([</span>
<span class="sd">            &#39;a&#39;, &#39;abbr&#39;, &#39;aside&#39;, &#39;audio&#39;, &#39;bdi&#39;, &#39;bdo&#39;, &#39;blockquote&#39;, &#39;canvas&#39;,</span>
<span class="sd">            &#39;caption&#39;, &#39;code&#39;, &#39;col&#39;, &#39;colgroup&#39;, &#39;data&#39;, &#39;dd&#39;, &#39;del&#39;,</span>
<span class="sd">            &#39;details&#39;, &#39;div&#39;, &#39;dl&#39;, &#39;dt&#39;, &#39;em&#39;, &#39;figcaption&#39;, &#39;figure&#39;, &#39;h1&#39;,</span>
<span class="sd">            &#39;h2&#39;, &#39;h3&#39;, &#39;h4&#39;, &#39;h5&#39;, &#39;h6&#39;, &#39;hr&#39;, &#39;i&#39;, &#39;img&#39;, &#39;ins&#39;, &#39;kbd&#39;, &#39;li&#39;,</span>
<span class="sd">            &#39;mark&#39;, &#39;ol&#39;, &#39;p&#39;, &#39;pre&#39;, &#39;q&#39;, &#39;rp&#39;, &#39;rt&#39;, &#39;ruby&#39;, &#39;s&#39;, &#39;samp&#39;,</span>
<span class="sd">            &#39;small&#39;, &#39;source&#39;, &#39;span&#39;, &#39;strong&#39;, &#39;sub&#39;, &#39;summary&#39;, &#39;sup&#39;,</span>
<span class="sd">            &#39;time&#39;, &#39;track&#39;, &#39;u&#39;, &#39;ul&#39;, &#39;var&#39;, &#39;video&#39;, &#39;wbr&#39;</span>
<span class="sd">        ])</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; html = &#39;&lt;span&gt;Hello, exploit: &lt;img src=&quot;javascript:alert(\&quot;pwned!\&quot;)&quot;&gt;&lt;/span&gt;&#39;</span>
<span class="sd">        &gt;&gt;&gt; strip_xss(html)</span>
<span class="sd">        (u&#39;&lt;span&gt;Hello, exploit: \u2421&lt;/span&gt;&#39;, [&#39;&lt;img src=&quot;javascript:alert(&quot;pwned!&quot;)&quot;&gt;&#39;])</span>

<span class="sd">    .. note:: The default *replacement* is the unicode ␡ character (u&quot;\u2421&quot;).</span>

<span class="sd">    If *replacement* is &quot;entities&quot; bad HTML tags will be encoded into HTML</span>
<span class="sd">    entities.  This allows things like &lt;script&gt;&#39;whatever&#39;&lt;/script&gt; to be</span>
<span class="sd">    displayed without execution (which would be much less annoying to users that</span>
<span class="sd">    were merely trying to share a code example).  Here&#39;s an example::</span>

<span class="sd">        &gt;&gt;&gt; html = &#39;&lt;span&gt;Hello, exploit: &lt;img src=&quot;javascript:alert(\&quot;pwned!\&quot;)&quot;&gt;&lt;/span&gt;&#39;</span>
<span class="sd">        &gt;&gt;&gt; strip_xss(html, replacement=&quot;entities&quot;)</span>
<span class="sd">        (&#39;&lt;span&gt;Hello, exploit: &amp;lt;span&amp;gt;Hello, exploit: &amp;lt;img src=&quot;javascript:alert(&quot;pwned!&quot;)&quot;&amp;gt;&amp;lt;/span&amp;gt;&lt;/span&gt;&#39;,</span>
<span class="sd">         [&#39;&lt;img src=&quot;javascript:alert(&quot;pwned!&quot;)&quot;&gt;&#39;])</span>
<span class="sd">        (u&#39;&lt;span&gt;Hello, exploit: \u2421&lt;/span&gt;&#39;, [&#39;&lt;img src=&quot;javascript:alert(&quot;pwned!&quot;)&quot;&gt;&#39;])</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function should work to protect against all `the XSS examples at</span>
<span class="sd">        OWASP &lt;https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet&gt;`_.</span>
<span class="sd">        Please `let us know &lt;https://github.com/liftoff/GateOne/issues&gt;`_ if</span>
<span class="sd">        you find something we missed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">re_html_tag</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="c1"># This matches HTML tags (if used correctly)</span>
      <span class="s2">&quot;(?i)&lt;\/?\w+((\s+\w+(\s*=\s*(?:</span><span class="se">\&quot;</span><span class="s2">.*?</span><span class="se">\&quot;</span><span class="s2">|&#39;.*?&#39;|[^&#39;</span><span class="se">\&quot;</span><span class="s2">&gt;\s]+))?)+\s*|\s*)\/?&gt;&quot;</span><span class="p">)</span>
    <span class="c1"># This will match things like &#39;onmouseover=&#39; (&#39;on&lt;whatever&gt;=&#39;)</span>
    <span class="n">on_events_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*\s+(on[a-z]+\s*=).*&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">whitelist</span><span class="p">:</span>
        <span class="c1"># These are all pretty safe and covers most of what users would want in</span>
        <span class="c1"># terms of formatting and sharing media (images, audio, video, etc).</span>
        <span class="n">whitelist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
            <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;abbr&#39;</span><span class="p">,</span> <span class="s1">&#39;aside&#39;</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">,</span> <span class="s1">&#39;bdi&#39;</span><span class="p">,</span> <span class="s1">&#39;bdo&#39;</span><span class="p">,</span> <span class="s1">&#39;blockquote&#39;</span><span class="p">,</span> <span class="s1">&#39;canvas&#39;</span><span class="p">,</span>
            <span class="s1">&#39;caption&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;colgroup&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;dd&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">,</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="s1">&#39;dl&#39;</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="s1">&#39;em&#39;</span><span class="p">,</span> <span class="s1">&#39;figcaption&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="s1">&#39;h1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;h2&#39;</span><span class="p">,</span> <span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="s1">&#39;h4&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">,</span> <span class="s1">&#39;h6&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;ins&#39;</span><span class="p">,</span> <span class="s1">&#39;kbd&#39;</span><span class="p">,</span> <span class="s1">&#39;li&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mark&#39;</span><span class="p">,</span> <span class="s1">&#39;ol&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;rp&#39;</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;samp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;strong&#39;</span><span class="p">,</span> <span class="s1">&#39;sub&#39;</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;sup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;ul&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;wbr&#39;</span>
        <span class="p">])</span>
    <span class="n">bad_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">re_html_tag</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="n">tag_lower</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">short_tag</span> <span class="o">=</span> <span class="n">tag_lower</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;&lt;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">short_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">whitelist</span><span class="p">:</span>
            <span class="n">bad_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Make sure the tag can&#39;t execute any JavaScript</span>
        <span class="k">if</span> <span class="s2">&quot;javascript:&quot;</span> <span class="ow">in</span> <span class="n">tag_lower</span><span class="p">:</span>
            <span class="n">bad_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># on&lt;whatever&gt; events are not allowed (just another XSS vuln)</span>
        <span class="k">if</span> <span class="n">on_events_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">tag_lower</span><span class="p">):</span>
            <span class="n">bad_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Flash sucks</span>
        <span class="k">if</span> <span class="s2">&quot;fscommand&quot;</span> <span class="ow">in</span> <span class="n">tag_lower</span><span class="p">:</span>
            <span class="n">bad_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># I&#39;d be impressed if an attacker tried this one (super obscure)</span>
        <span class="k">if</span> <span class="s2">&quot;seeksegmenttime&quot;</span> <span class="ow">in</span> <span class="n">tag_lower</span><span class="p">:</span>
            <span class="n">bad_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Yes we&#39;ll protect IE users from themselves...</span>
        <span class="k">if</span> <span class="s2">&quot;vbscript:&quot;</span> <span class="ow">in</span> <span class="n">tag_lower</span><span class="p">:</span>
            <span class="n">bad_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">if</span> <span class="n">replacement</span> <span class="o">==</span> <span class="s2">&quot;entities&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">cgi</span>
        <span class="k">for</span> <span class="n">bad_tag</span> <span class="ow">in</span> <span class="n">bad_tags</span><span class="p">:</span>
            <span class="n">escaped</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">html</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;xmlcharrefreplace&#39;</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">bad_tag</span><span class="p">,</span> <span class="n">escaped</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bad_tag</span> <span class="ow">in</span> <span class="n">bad_tags</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">bad_tag</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">bad_tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_signature"><a class="viewcode-back" href="../../../Developer/utils.html#gateone.core.utils.create_signature">[docs]</a><span class="k">def</span> <span class="nf">create_signature</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an HMAC signature using the given *parts* and *kwargs*.  The first</span>
<span class="sd">    argument **must** be the &#39;secret&#39; followed by any arguments that are to be</span>
<span class="sd">    part of the hash.  The only *kwargs* that is used is &#39;hmac_algo&#39;.</span>
<span class="sd">    &#39;hmac_algo&#39; may be any HMAC algorithm present in the hashlib module.  If not</span>
<span class="sd">    provided, `hashlib.sha1` will be used.  Example usage::</span>

<span class="sd">        create_signature(</span>
<span class="sd">            &#39;secret&#39;,</span>
<span class="sd">            &#39;some-api-key&#39;,</span>
<span class="sd">            &#39;user@somehost&#39;,</span>
<span class="sd">            &#39;1234567890123&#39;,</span>
<span class="sd">            hmac_algo=hashlib.sha1)</span>

<span class="sd">    .. note::</span>

<span class="sd">        The API &#39;secret&#39; **must** be the first argument.  Also, the order</span>
<span class="sd">        *does* matter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1"># encode() because hmac takes bytes</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">hmac_algo</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hmac_algo&#39;</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span> <span class="c1"># Default to sha1</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hmac_algo</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="n">part</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="c1"># str() in case of an int</span>
        <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<span class="c1"># Misc</span>
<span class="k">if</span> <span class="n">MACOS</span> <span class="ow">or</span> <span class="n">OPENBSD</span><span class="p">:</span> <span class="c1"># Apply BSD-specific stuff</span>
    <span class="n">kill_dtached_proc</span> <span class="o">=</span> <span class="n">kill_dtached_proc_bsd</span>
    <span class="n">killall</span> <span class="o">=</span> <span class="n">killall_bsd</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Liftoff Software Corporation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
window.onload = function(e) {
    // Make our collapseindex elements actually collapsible
    $('<span class="collapsindextitle">Index</span> <a class="showhide">[show]</a>').insertBefore('.collapseindex');
    $('.showhide').each(function(index, value){
        var showHide = $(this);
        showHide.click(function() {
            if (this.innerHTML == "[hide]") {
                this.innerHTML = "[show]";
            } else {
                this.innerHTML = "[hide]";
            }
            $(this).next('.collapseindex').toggle(1); // This should always be the next .collapseindex element
        });
    });
    $('.collapseindex').each(function(index, value){
        // Start them out hidden
        $(this).hide();
    });
}
</script>


</body>
</html>